---
title: Swfit - ì˜¤í¼ë ˆì´ì…˜
---

ì•„ë˜ ë‚´ìš©ì€ [ì¸í”„ëŸ° - ì•¨ëŸ° iOS Concurrency í”„ë¡œê·¸ë˜ë°](https://www.inflearn.com/course/iOS-Concurrency-GCD-Operation/dashboard) ê°•ì˜ ë‚´ìš©ì„ ìš”ì•½í•œ ê¸€ì…ë‹ˆë‹¤.

## ì˜¤í¼ë ˆì´ì…˜

ì˜¤í¼ë ˆì´ì…˜ì€ ì‘ì—…ì„ í´ë˜ìŠ¤ í˜•íƒœë¡œ êµ¬í˜„í•˜ì—¬ ì„¸ë¶€ ë™ì‘ì„ ì •ì˜í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤. (ë°ì´í„° ë‹¤ìš´ë¡œë“œ, ì••ì¶•í’€ê¸° ë“±) ì‘ì—…ì„ í´ë˜ìŠ¤í™” í•  ê²½ìš° ì¬ì‚¬ìš©ì„±ì´ ì˜¬ë¼ê°„ë‹¤. ì˜¤í¼ë ˆì´ì…˜ì€ ì—¬ëŸ¬ ê¸°ëŠ¥ì´ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µë˜ëŠ”ë°, ëŒ€í‘œì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ë“¤ì´ ìˆë‹¤.

1. ì‘ì—… ì·¨ì†Œ
2. ìˆœì„œì§€ì •(ì˜ì¡´ì„±)
3. ìƒíƒœì²´í¬ (state machine)
4. KVO notifications
5. Qos ìˆ˜ì¤€ (ì‘ì—… ìš°ì„ ìˆœìœ„ ì§€ì •)
6. completionBlock ì œê³µ (ì»´í”Œë¦¬ì…˜ í•¸ë“¤ëŸ¬ í´ë¡œì €ì™€ ë™ì¼)

ì˜¤í¼ë ˆì´ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ `start()`, `cancel()`ë©”ì„œë“œë¥¼ ë³´ìœ í•˜ê³  ìˆë‹¤. ë˜í•œ ì‘ì—… í˜„í™©ì„ ì•Œ ìˆ˜ ìˆëŠ” ì†ì„±ê°’ë“¤ë„ ì¡´ì¬í•œë‹¤.

1. `isReady`
2. `isExecuting`
3. `isCancelled`
4. `isFinished`

:::warning ì°¸ê³ 

1. ì˜¤í¼ë ˆì´ì…˜ ê°ì²´ëŠ” ìƒì„± ë° í• ë‹¹ ì´í›„ í•œë²ˆì˜ ë¼ì´í”„ì‚¬ì´í´ë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤. í•´ë‹¹ ì‘ì—…ì„ ë‹¤ì‹œ ì‹œì‘í•˜ê³  ì‹¶ì€ ê²½ìš° ê°ì²´ë¥¼ ì¬ìƒì„±, ì¬í• ë‹¹ í•´ì•¼í•œë‹¤.
2. ì˜¤í¼ë ˆì´ì…˜ì€ ë³„ë‹¤ë¥¸ ì²˜ë¦¬ê°€ ì—†ìœ¼ë©´ ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ë™ê¸°ì ìœ¼ë¡œ ë™ì‘í•œë‹¤.

:::

ì˜¤í¼ë ˆì´ì…˜ì€ `Opeartion`í´ë˜ìŠ¤ ìƒì† í›„ ë‚´ë¶€ ì‘ì—…ì„ ì§ì ‘ ì •ì˜í•´ì•¼ í•œë‹¤.

1. input
2. main() - ì‹¤ì œë¡œ ì²˜ë¦¬í•  ë‚´ë¶€ ë™ì‘, mainë©”ì„œë“œë¥¼ `Operation` í´ë˜ìŠ¤ë¡œë¶€í„° ì˜¤ë²„ë¼ì´ë”©
3. output

```swift
class SomeOperation: Operation{
    var inputImage: UIImage?
    var outputImage: UIImage?

    override func main(){
        // ì‹¤ì œ ë™ì‘
    }
}

let op = SomeOperation()
// op.qualityOfService = .userInteractive
```

ì˜¤í¼ë ˆì´ì…˜ ìì²´ì— qosë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

## ë¼ì´í”„ì‚¬ì´í´

1. ì˜¤í¼ë ˆì´ì…˜ ê°ì²´ ìƒì„± ë° í• ë‹¹ í›„ - `isReady: true`
2. `start()` ë©”ì„œë“œ ì‹¤í–‰ í›„ - `isExecuting: true`
3. ì‘ì—… ë§ˆë¬´ë¦¬ í›„ - `isFinished: true, isExecuting: false, isReady: true`
4. `cancel()`ë©”ì„œë“œ í˜¸ì¶œ ë’¤ - `isCancelled: true, isFinished: true, isExecuting: false`

## ì˜¤í¼ë ˆì´ì…˜ í

ì˜¤í¼ë ˆì´ì…˜íëŠ” ì˜¤í¼ë ˆì´ì…˜ë“¤ì„ ë‹´ì•„ ì‚¬ìš©í•˜ëŠ” íì´ë‹¤. ì˜¤í¼ë ˆì´ì…˜ í ìƒì„±ì‹œ ì„¤ì •í•´ì¤˜ì•¼ í•˜ëŠ” ê²ƒë“¤ì´ ëª‡ê°€ì§€ ìˆë‹¤.

1. ì§ë ¬ íì¸ì§€ ë™ì‹œ íì¸ì§€
2. ë™ì‹œ íë¼ë©´ ëª‡ê°œì˜ ì“°ë ˆë“œë¥¼ ì‚¬ìš©í•  ì§€ (default: -1, ì“°ë ˆë“œ ìƒì„±ì„ ëª¨ë‘ ì‹œìŠ¤í…œì—ê²Œ ìœ„ì„í•œë‹¤)
    - ì†ì„±ì˜ ì´ë¦„ì€ `maxConcurrentOperationCount`ì´ë‹¤.
    - ì§ë ¬ íì˜ ê²½ìš° 1ê°’ì„, ë™ì‹œ íì˜ ê²½ìš° 2 ì´ìƒì˜ ê°’ì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.
3. QoS ì„¤ì •
    - `queue.qualityOfService`ë¥¼ í†µí•´ ì„¤ì • ê°€ëŠ¥í•˜ë‹¤.
    - ë””í´íŠ¸ëŠ” backgroundë¥¼ ê°–ëŠ”ë‹¤.
    - `.userInteractive`, `.userInitiated`, `.default`, `.utility`, `.background` ë‹¤ì„¯ê°€ì§€ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆë‹¤. ì„¤ì •ì€ `queue.qualityOfService = .userInteractive` í˜•íƒœë¡œ í•œë‹¤.
    - ì˜¤í¼ë ˆì´ì…˜ íëŠ” `queue.underlyingQueue = .global()`ë¼ëŠ” ì†ì„±ë„ ì§€ì›í•œë‹¤. ê¸°ë°˜ íë¥¼ ê¸€ë¡œë²Œ íë¡œ ì§€ì •í•¨ìœ¼ë¡œì¨ ì˜¤í¼ë ˆì´ì…˜ íë“¤ ì¤‘ ì–´ë– í•œ ì„œë¹„ìŠ¤ í’ˆì§ˆë³´ë‹¤ë„ ê°€ì¥ ì•ì„  ìˆœìœ„ë¥¼ ê°–ê²Œ í•  ìˆ˜ ìˆë‹¤.
4. ì˜¤í¼ë ˆì´ì…˜ íì—ëŠ” í´ë¡œì €, ì˜¤í¼ë ˆì´ì…˜, ì˜¤í¼ë ˆì´ì…˜ ë°°ì—´ì„ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.
    - ì˜¤í¼ë ˆì´ì…˜ íì—ì„œ ë‹¤ë¥¸ ì“°ë ˆë“œì— ì‘ì—…ì„ ë°°ì¹˜í–ˆì„ë•Œ ì˜¤í¼ë ˆì´ì…˜ ë¼ì´í”„ì‚¬ì´í´ì´ `isExecuting` ìƒíƒœê°€ ëœë‹¤.
5. ì˜¤í¼ë ˆì´ì…˜ ì‹¤í–‰ ë˜ëŠ” ì·¨ì†Œì‹œ ì˜¤í¼ë ˆì´ì…˜ íë¥¼ ë– ë‚œë‹¤. ì´ë¡œ ì¸í•´ ì˜¤í¼ë ˆì´ì…˜ ê°ì²´ë¥¼ `One Single-Shot` ê°ì²´ë¼ê³  ë¶€ë¥¸ë‹¤.
6. ì˜¤í¼ë ˆì´ì…˜ íì—ëŠ” ë™ê¸°ì ìœ¼ë¡œ ê¸°ë‹¤ë¦¬ëŠ” ë©”ì„œë“œê°€ ì¡´ì¬í•œë‹¤.
    - ì˜¤í¼ë ˆì´ì…˜ í ë‚´ì˜ ëª¨ë“  ì‘ì—…ì´ ë§ˆë¬´ë¦¬ ë ë•Œê¹Œì§€ ëŒ€ê¸°í•œë‹¤. `waitUntilAllOperationsAreFinished()`
    - `Blocks the current thread until all the receiverâ€™s queued and executing operations finish executing.`ë¡œ ê³µì‹ë¬¸ì„œì— ì •ì˜ë˜ì–´ ìˆìœ¼ë©°, `finish executing`ì´ë¼ê³  ì–¸ê¸‰ë˜ëŠ” ê²ƒì„ ë³´ë‹ˆ ë¼ì´í”„ì‚¬ì´í´ isFinishedê°€ ë ë•Œê¹Œì§€ ë¸”ë¡í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.
7. ì¼ì‹œì¤‘ì§€ / ì¬ê°œ ê°€ëŠ¥
    - ì˜¤í¼ë ˆì´ì…˜ íì˜ `isSuspended` ì†ì„±ì„ Boolê°’ìœ¼ë¡œ ì¡°ì ˆ ê°€ëŠ¥í•˜ë‹¤.
    - `isSuspended`ê°€ trueë¡œ ì„¤ì •ë˜ë©´ ì˜¤í¼ë ˆì´ì…˜ íê°€ ì¼ì‹œì •ì§€ ë˜ì§€ë§Œ, ê¸°ì¡´ ì‹¤í–‰ë˜ë˜ ì˜¤í¼ë ˆì´ì…˜ì€ ê³„ì† ì²˜ë¦¬ëœë‹¤.
    - ë‹¤ìŒ ì¶”ê°€ë˜ëŠ” ì˜¤í¼ë ˆì´ì…˜ë“¤ì€ `isSuspended`ê°€ `false`ë¡œ ì„¤ì •ë ë•Œê¹Œì§€ ì“°ë ˆë“œ ë°°ì • ë“±ì˜ ìŠ¤ì¼€ì¤„ë§ì´ ì´ë£¨ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤.

```swift
let someQueue = OperationQueue()

// ì˜¤í¼ë ˆì´ì…˜ í•˜ë‚˜ë§Œ ì¶”ê°€
someQueue.addOperation(ì˜¤í¼ë ˆì´ì…˜)

// ì˜¤í¼ë ˆì´ì…˜ ì—¬ëŸ¬ê°œ ì¶”ê°€
someQueue.addOperation([ì˜¤í¼ë ˆì´ì…˜ë“¤], waitUntilFinished: true) // ì˜¤í¼ë ˆì´ì…˜ ë°°ì—´ ëª¨ë‘ê°€ fisishë ë•Œê¹Œì§€ ë™ê¸°ì ìœ¼ë¡œ ê¸°ë‹¤ë¦¬ê² ë‹¤
```

ì˜¤í¼ë ˆì´ì…˜ ê°ì²´ í•˜ë‚˜ë§Œ ìƒì„± í›„ `start`ë©”ì„œë“œ ë“±ìœ¼ë¡œ ê´€ë¦¬í•˜ë©´ ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì§€ë§Œ, ì˜¤í¼ë ˆì´ì…˜ íì— ì˜¤í¼ë ˆì´ì…˜ì„ ë„£ëŠ” ìˆœê°„ ì´ë“¤ ì˜¤í¼ë ˆì´ì…˜ì€ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë™ì‘í•œë‹¤.

## ë¸”ë½ ì˜¤í¼ë ˆì´ì…˜ (BlockOperation)

ë¸”ë½ ì˜¤í¼ë ˆì´ì…˜ì€ ì˜¤í¼ë ˆì´ì…˜ ë‚´ì— ë¸”ë¡ë“¤ì„ ë‚´ì¥í•˜ê³  ìˆëŠ” ì˜¤í¼ë ˆì´ì…˜ì´ë‹¤. ë¸”ë½ ì˜¤í¼ë ˆì´ì…˜ì€ ë””ìŠ¤íŒ¨ì¹˜ ê·¸ë£¹ê³¼ ìœ ì‚¬í•˜ê²Œ ë™ì‘í•˜ë©° ì—¬ëŸ¬ ì“°ë ˆë“œì— ê±¸ì³ ë¸”ë¡ë“¤ì´ ë™ì‹œì²˜ë¦¬ ë˜ì–´ë„ ëª¨ë“  ë¸”ë¡ ì‹¤í–‰ì´ ë§ˆì¹ ë•Œê¹Œì§€ ë‹¤ë¥¸ íƒœìŠ¤í¬ í• ë‹¹ì´ ì´ë£¨ì–´ì§€ì§€ ì•Šê²Œë” ë™ê¸°ì ìœ¼ë¡œ ì„¤ê³„ë˜ì–´ ìˆë‹¤.

ë¸”ë¡ ì˜¤í¼ë ˆì´ì…˜ì€ ê¸°ë³¸ `Operation`ì— Blockì´ ë”í•´ì§„ í˜•íƒœì´ë‹¤. ë”°ë¼ì„œ ê¸°ë³¸ì ì¸ ì˜¤í¼ë ˆì´ì…˜ ê¸°ëŠ¥ì„ ê°€ì§€ë©°, ë””ìŠ¤íŒ¨ì¹˜ ê·¸ë£¹ë“¤ì˜ ê¸°ëŠ¥ë“¤ì„ ì¶”ê°€ì ìœ¼ë¡œ ê°–ëŠ” ê²ƒì´ë¼ ìƒê°í•˜ë©´ ëœë‹¤.

ì˜¤í¼ë ˆì´ì…˜ì„ ë§ì´ ê°–ëŠ” ì•±ì¼ ê²½ìš°, ë§¤ë²ˆ input, main, outputì„ ì˜¤í¼ë ˆì´ì…˜ë§ˆë‹¤ ì •ì˜í•˜ëŠ” ê²ƒë³´ë‹¤ í´ë¡œì € í˜•íƒœë¡œ ì •ì˜í•˜ê¸°ì— í¸í•˜ë‹¤.

```swift
let aOperation = BlockOperation()

aOperation.addExecutionBlock{
    // ë¸”ë¡ ì¶”ê°€
}

// í´ë¡œì € í˜•íƒœë¡œ ë¸”ë¡ì„ ì •ì˜
let bOperation = BlockOperation{
    result = 2 + 3
    print("ì‘ì—…!")
}
```

## ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜

ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ì€ ì˜¤í¼ë ˆì´ì…˜ ë‚´ì— ë¹„ë™ê¸° í•¨ìˆ˜ê°€ í¬í•¨ëœ ê²ƒì„ ì˜ë¯¸í•œë‹¤. ì˜¤í¼ë ˆì´ì…˜ íë¥¼ í†µí•´ ë‹¤ë¥¸ ì“°ë ˆë“œë¡œ ì˜¤í¼ë ˆì´ì…˜ì´ í• ë‹¹ëœ í›„, ë‚´ë¶€ ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ê²Œ ë˜ëŠ”ë° ì´ë•Œ ë˜ ë‹¤ì‹œ ë‚´ë¶€ ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ë‹¤ë¥¸ ì“°ë ˆë“œë¡œ ë³´ë‚´ê²Œ ëœë‹¤.

ì´ë•Œ ì˜¤í¼ë ˆì´ì…˜ì€ `isFinished` ì‚¬ì´í´ì„ ì ìš©í•  ë•Œê°€ ë˜ì—ˆìŒì—ë„ ë¹„ë™ê¸° í•¨ìˆ˜ëŠ” ì¢…ë£Œë˜ì§€ ì•Šì€ ìƒíƒœì¼ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ì˜ ê²½ìš°ì—ëŠ” ì˜¤í¼ë ˆì´ì…˜ ìƒíƒœì˜ ê´€ë¦¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ í•´ì¤˜ì•¼ í•œë‹¤. í•˜ì§€ë§Œ **ì˜¤í¼ë ˆì´ì…˜ ìƒíƒœê°’ì€ ì½ê¸° ì „ìš©ì˜ ê°’ì´ë¯€ë¡œ ì†ì„±ê°’ì„ ì§ì ‘ ë³€ê²½í•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.** ìƒíƒœ ë¿ ì•„ë‹ˆë¼ notificationë„ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬í•´ì•¼í•œë‹¤.

ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ ì²˜ë¦¬ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ìœ¼ë¡œ ì´ë£¨ì–´ì§„ë‹¤.

1. `Operation` í´ë˜ìŠ¤ë¥¼ ìƒì†í•œ `AsyncOperation` í´ë˜ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.
2. `AsyncOperation` í´ë˜ìŠ¤ëŠ” ì‹¤ì§ˆì ìœ¼ë¡œëŠ” ì§ì ‘ ì •ì˜í•´ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ì´ì§€ë§Œ, ì‚¬ì‹¤ìƒ ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì½”ë“œë¥¼ ê°€ì ¸ë‹¤ê°€ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
3. `AsyncOperation` í´ë˜ìŠ¤ë¥¼ ìƒì†í•˜ì—¬ ì»¤ìŠ¤í…€ ì˜¤í¼ë ˆì´ì…˜ì„ ìƒˆë¡­ê²Œ ì •ì˜í•œë‹¤. ë‚˜ë¨¸ì§€ëŠ” ê¸°ì¡´ ì˜¤í¼ë ˆì´ì…˜ êµ¬í˜„ê³¼ ë™ì¼í•˜ê²Œ `Input`, `main`, `output`ì„ ì •ì˜í•˜ë©´ ëœë‹¤.
    - `main`ì—ëŠ” ì˜¤í¼ë ˆì´ì…˜ ìƒíƒœë¥¼ ì²´í¬í•˜ëŠ” ì½”ë“œë¥¼ ë„£ì–´ì•¼ í•œë‹¤. ë¹„ë™ê¸° ë™ì‘ì˜ ì»´í”Œë¦¬ì…˜ í•¸ë“¤ëŸ¬ ë¶€ë¶„ì—ì„œ ì˜¤í¼ë ˆì´ì…˜ ìƒíƒœë¥¼ `isFinished` ì‚¬ì´í´ë¡œ ë°”ê¿”ì¤˜ì•¼ í•˜ëŠ” ê²ƒì´ë‹¤.

ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```swift
class AsyncOperation: Operation {
    // Enum ìƒì„±
    enum State: String {
        case ready, executing, finished

        // KVO notificationsì„ ìœ„í•œ keyPathì„¤ì •
        fileprivate var keyPath: String {
            return "is\(rawValue.capitalized)"
        } // isReady/isExecuting/isFinished
    }

    // ì§ì ‘ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ìƒíƒœ ë³€ìˆ˜ ìƒì„±
    var state = State.ready {
        willSet {
            willChangeValue(forKey: newValue.keyPath)
            willChangeValue(forKey: state.keyPath)
        }
        didSet {
            didChangeValue(forKey: oldValue.keyPath)
            didChangeValue(forKey: state.keyPath)
        }
    }
}

extension AsyncOperation {
    // ìƒíƒœì†ì„±ì€ ëª¨ë‘ read-only
    override var isReady: Bool {
        return super.isReady && state == .ready
    }

    override var isExecuting: Bool {
        return state == .executing
    }

    override var isFinished: Bool {
        return state == .finished
    }

    override var isAsynchronous: Bool {  // ë¬´ì¡°ê±´ trueë¡œ ë¦¬í„´
        return true
    }

    override func start() {
        if isCancelled {
            state = .finished
            return
        }
        main()
        state = .executing
    }

    override func cancel() {
        super.cancel()
        state = .finished
    }
}
```

ë‚´ì¥ `Operation` í´ë˜ìŠ¤ì˜ ë¼ì´í”„ì‚¬ì´í´ ìƒíƒœê°’ì€ `read-only`ì´ê¸° ë•Œë¬¸ì— ì§ì ‘ ìƒíƒœ ê´€ë¦¬ê°€ ì•ˆë˜ì§€ë§Œ ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ì—ì„œëŠ” ë°˜ë“œì‹œ ì§ì ‘ ê´€ë¦¬ë¥¼ í•´ì•¼ë§Œ í•œë‹¤. ì´ë¥¼ ìœ„í•´ `AsyncOperation`í´ë˜ìŠ¤ë¥¼ ì •ì˜í• ë•Œ ìƒìœ„ ë¼ì´í”„ì‚¬ì´í´ ì†ì„±ë“¤ì„ ì˜¤ë²„ë¼ì´ë”© í•˜ì—¬ ê³„ì‚°ì†ì„±ìœ¼ë¡œ ì •ì˜ë¥¼ í•˜ê³  ìˆëŠ” ê²ƒì´ë‹¤.

ì‚¬ìš© ì˜ˆì‹œ ì½”ë“œë¥¼ ë³´ì.

```swift
class SumOperation: AsyncOperation {
    // ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ input
    var lhs: Int
    var rhs: Int

    // ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ output
    var result: Int?

    // ì´ˆê¸°í™”ë©”ì„œë“œ í¬í•¨(ì†ì„± ì„¤ì • ë•Œë¬¸ì—)
    init(lhs: Int, rhs: Int) {
        self.lhs = lhs
        self.rhs = rhs
        super.init()
    }

    // ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ main
    override func main() {
        // asyncAdd_OpQëŠ” ë¹„ë™ê¸° í•¨ìˆ˜ì´ë‹¤.
        asyncAdd_OpQ(lhs: lhs, rhs: rhs) { result in
            self.result = result

            // ë¼ì´í”„ì‚¬ì´í´ ì§ì ‘ ì§€ì •
            self.state = .finished   // ì»´í”Œë¦¬ì…˜ í•¸ë“¤ëŸ¬ì—ì„œ ìƒíƒœë¥¼ .finishedë¡œ ì…‹íŒ…
        }
    }
}

// ì‹¤í–‰ ì˜ˆì‹œ
// ë§ì…ˆ ëŒ€ìƒ
let input = [(1,5), (5,8), (6,1), (3,9), (6,12), (1,0)]

// ì˜¤í¼ë ˆì´ì…˜ í
let additionQueue = OperationQueue()

// forë¬¸ì„ ëŒë©° ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ ì¶”ê°€
for (lhs, rhs) in input {
    let operation = SumOperation(lhs: lhs, rhs: rhs)

    // ì»´í”Œë¦¬ì…˜ ë¸”ë¡ ì •ì˜
    operation.completionBlock = {
        guard let result = operation.result else { return }
        print("\(lhs) + \(rhs) = \(result)")
    }

    // ì˜¤í¼ë ˆì´ì…˜ íì— ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ ì „ë‹¬
    // ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ì´ ë‹¤ë¥¸ ìŠ¤ë ˆë“œë¡œ ì „ë‹¬ë˜ê³ , ë‚´ë¶€ ë¹„ë™ê¸° í•¨ìˆ˜ê°€ ë‹¤ì‹œ ë‹¤ë¥¸ ìŠ¤ë ˆë“œë¡œ ì „ë‹¬ëœë‹¤.
    additionQueue.addOperation(operation)
}
```

ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ê°€ ë­˜ê¹Œ? ë¹„ë™ê¸° ë™ì‘ì˜ ìˆœì„œê°€ ì¤‘ìš”í•œ ê²½ìš°ê°€ ë¶„ëª… ì¡´ì¬í•œë‹¤. ì˜ˆì»¨ëŒ€ íŠ¹ì • ë°ì´í„°ëŠ” ì´ì „ ë°ì´í„°ì— ì˜ì¡´ì ìœ¼ë¡œ ì¡´ì¬í•˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤. ì´ì „ ë°ì´í„° ì—­ì‹œ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°›ì•„ì™€ì•¼ í•œë‹¤ë©´ ë¹„ë™ê¸°ì ì¸ ë°ì´í„° ê°„ì˜ ìˆœì„œê°€ ë³´ì¥ë˜ì–´ì•¼ í•˜ëŠ” ê²ƒì´ë‹¤.

ì»´í”Œë¦¬ì…˜ í•¸ë“¤ëŸ¬ë¥¼ ì—°ì†ì ìœ¼ë¡œ ë°°ì¹˜í•˜ë©´ ìë°”ìŠ¤í¬ë¦½íŠ¸ ES6 í”„ë¼ë¯¸ìŠ¤ì—ì„œ ì½œë°± ì§€ì˜¥ í˜•íƒœì˜ ì½”ë“œê°€ ì‘ì„±ëœë‹¤.

ë¹„ë™ê¸° ì˜¤í¼ë ˆì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ ì˜¤í¼ë ˆì´ì…˜ íì— `addOperation`ë§Œ ìˆœì°¨ì ìœ¼ë¡œ í•´ì£¼ë©´ ë˜ê¸° ë•Œë¬¸ì— ì½”ë“œ ê°€ë…ì„±ì´ ë§¤ìš° ê°œì„ ë  ê²ƒì´ë‹¤.

## ì˜¤í¼ë ˆì´ì…˜ ì£¼ìš” ê¸°ëŠ¥

ì˜¤í¼ë ˆì´ì…˜ íì—ì„œ ìˆœì„œ ê´€ë¦¬ê°€ ì´ë£¨ì–´ì§€ëŠ”ê±´ ì§ë ¬ íë¥¼ í†µí•œ ì²˜ë¦¬ì™€ ìœ ì‚¬í•˜ì§€ë§Œ ì—¬ëŸ¬ ì“°ë ˆë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë§ë‹¤. ë‹¤ìŒ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒê°í•´ë³´ë©´,

1. ë¦¬ì†ŒìŠ¤ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ëŠ”ë‹¤. (input: URL, main: ë‹¤ìš´ë¡œë“œ, output: ì••ì¶•íŒŒì¼)
2. ë¦¬ì†ŒìŠ¤ì˜ ì••ì¶•ì„ í‘¼ë‹¤. (input: ì••ì¶•íŒŒì¼, main: ë””ì»´í”„ë ˆì‹±, output: ë‚´ë¶€ íŒŒì¼)

ìœ„ ë‘ ì‘ì—…ì„ í•œ ì˜¤í¼ë ˆì´ì…˜ìœ¼ë¡œ ì •ì˜í•˜ë©´ ëª¨ë“ˆí™” ê´€ì ì—ì„œ ì¢‹ì€ ì½”ë“œê°€ ì•„ë‹ˆë‹¤. ë‘˜ì„ ë³„ê°œì˜ ì˜¤í¼ë ˆì´ì…˜ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ë” ì¢‹ë‹¤. ì´ë•Œ ì˜¤í¼ë ˆì´ì…˜ ê°„ì˜ ì„ í›„ ê´€ê³„ê°€ ëª…í™•í•˜ë¯€ë¡œ **ì˜ì¡´ì„± ì„¤ì •ì´ í•„ìš”í•˜ë©°** ì„ í›„ ê´€ê³„ ì‚¬ì´ì—ì„œ **ì˜¤í¼ë ˆì´ì…˜ ê°„ì˜ í†µì‹ ì„ ìœ„í•œ í”„ë¡œí† ì½œ ì •ì˜ê°€ í•„ìš”í•˜ë‹¤.**

í”„ë¡œí† ì½œ ì±„íƒì€ ì¸í’‹ì„ ì „ë‹¬ë°›ëŠ” ì˜¤í¼ë ˆì´ì…˜ì´ ì•„ë‹Œ ì•„ì›ƒí’‹ì„ ì „ë‹¬í•˜ëŠ” ì˜¤í¼ë ˆì´ì…˜ ìª½ì—ì„œ ì±„íƒí•œë‹¤. ë‹¤ìŒ ì˜¤í¼ë ˆì´ì…˜ì˜ ì¸í’‹ì€ ì´ì „ ì˜¤í¼ë ˆì´ì…˜ì—ì„œ ë½‘ì•„ì˜¨ë‹¤.

ì˜¤í¼ë ˆì´ì…˜ ì˜ì¡´ì„± ëŒ€ìƒë“¤ì€ ê¸°ë³¸ `Operation` í´ë˜ìŠ¤ì˜ `dependencies` ì†ì„±ìœ¼ë¡œ ê´€ë¦¬ëœë‹¤. ë””íœë˜ì‹œ ì¶”ê°€ëŠ” `ì „ë‹¬ë°›ëŠ”_ì˜¤í¼ë ˆì´ì…˜.addDependency(ì „ë‹¬í•˜ëŠ”_ì˜¤í¼ë ˆì´ì…˜)` ë©”ì„œë“œ í˜¸ì¶œë¡œ ê°€ëŠ¥í•˜ë‹¤.

```swift
// ì•„ì›ƒí’‹ì„ ì „ë‹¬í•˜ëŠ” ì˜¤í¼ë ˆì´ì…˜
class ImageLoadOperation: AsyncOperation {
    var inputName: String?
    var outputImage: UIImage?

    override func main() {
        // ì´ ë©”ì„œë“œëŠ” ì ê¹ sleepí–ˆë‹¤ê°€ ì´ë¯¸ì§€ë¥¼ ë°˜í™˜í•˜ëŠ” ì‹œë®¬ë ˆì´íŒ… ë©”ì„œë“œì„.
        simulateAsyncNetworkLoadImage(named: self.inputName) {
            [unowned self] (image) in
            self.outputImage = image
            self.state = .finished
        }
    }
}

// ì „ë‹¬í•  ì•„ì›ƒí’‹ì— ëŒ€í•œ í”„ë¡œí† ì½œ ì •ì˜
protocol FilterDataProvider {
    var image: UIImage? { get }
}

// í”„ë¡œí† ì½œ ì±„íƒí•˜ê¸°
extension ImageLoadOperation: FilterDataProvider {
    var image: UIImage? { return outputImage }
}


// ì´ë¯¸ì§€ ë³€í™˜, ì¦‰ ì•„ì›ƒí’‹ì„ ì´ì „ ì˜¤í¼ë ˆì´ì…˜ì˜ ì¸í’‹ìœ¼ë¡œ ë°›ëŠ” ì˜¤í¼ë ˆì´ì…˜
class TiltShiftOperation: Operation {
    var inputImage: UIImage?
    var outputImage: UIImage?

    override func main() {
        // ğŸ”¸ğŸ”¸ğŸ”¸ 2) í”„ë¡œí† ì½œ ì±„íƒí•œ ì•ì˜ ì˜¤í¼ë ˆì´ì…˜ì—ì„œ, ì¸í’‹ê°’ì„ ì–»ì–´ë‚´ê¸°
        if inputImage == .none,    // ì¸í’‹ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´,
            let dependencyImageProvider = dependencies
                // í´ë¡œì € 0ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ ë””íœë˜ì‹œë¥¼ ìˆœíšŒí•œë‹¤.
                // ë””íœë˜ì‹œ íƒ€ì…ì´ íŠ¹ì • í”„ë¡œí† ì½œì— í•´ë‹¹í•œë‹¤ë©´? í•´ë‹¹ ìš”ì†Œë§Œ ì–»ëŠ”ë‹¤
                // filterë©”ì„œë“œëŠ” ì¡°ê±´ì„ ì¶©ì¡±í•˜ëŠ” ìš”ì†Œë“¤ì„ ëª¨ì•„ë†“ì€ ë°°ì—´ì„
                // ë°°ì—´ Firstì ‘ê·¼ì„ í†µí•´ í”„ë¡œí† ì½œ íƒ€ì…ì— í•´ë‹¹í•˜ë©´ -> ì¸í’‹ìœ¼ë¡œ ì‚¬ìš©
                .filter({ $0 is FilterDataProvider})
                .first as? FilterDataProvider {   // (ì˜ì¡´í•˜ê³  ìˆëŠ”) ì˜¤í¼ë ˆì´ì…˜ì˜ ë°°ì—´ì—ì„œ ì˜¤í¼ë ˆì´ì…˜ êº¼ë‚´ê¸°
                inputImage = dependencyImageProvider.image
        }

        // ì‹¤ì œ ì‘ì—…
        outputImage = tiltShift(image: inputImage)
    }
}

// ì•ì˜ ì˜¤í¼ë ˆì´ì…˜ ì •ì˜
let imageLoad = ImageLoadOperation()

// ë’¤ì˜ ì˜¤í¼ë ˆì´ì…˜ ì •ì˜
let filter = TiltShiftOperation()

// ì˜¤í¼ë ˆì´ì…˜ ì¸í’‹ ì •ì˜
imageLoad.inputName = "train_day.jpg"

// ë””íœë˜ì‹œ ì—°ê²°
filter.addDependency(imageLoad)


// íì— ì˜¤í¼ë ˆì´ì…˜ ë„£ê¸° (ë™ê¸°ì ìœ¼ë¡œ ê¸°ë‹¤ë¦¬ê²Œ í•´ì„œ í™•ì¸í•´ë³´ê¸°)
let queue = OperationQueue()

// ì‘ì—… ì‹œì‘
queue.addOperations([imageLoad, filter], waitUntilFinished: true)
```

:::tip ì˜¤í¼ë ˆì´ì…˜ í ì‘ì—…ì·¨ì†Œ

ì˜¤í¼ë ˆì´ì…˜ íì—ëŠ” `cancelAllOperations()` ë©”ì„œë“œê°€ ìˆë‹¤. í ë‚´ì˜ ëª¨ë“  ì˜¤í¼ë ˆì´ì…˜ë“¤ì˜ `isCancelled` ì†ì„±ì„ trueë¡œ ì„¤ì •í•œë‹¤.

```swift
class ArraySumOperation: Operation {
    let inputArray: [(Int, Int)]
    var outputArray = [Int]()

    init(input: [(Int, Int)]) {
        inputArray = input
        super.init()
    }

    override func main() {
        // ë”í•´ì„œ ë°°ì—´ì— ë„£ê¸°
        for pair in inputArray {
            // ì†ì„± í™•ì¸ í›„ ë¦¬í„´
            if isCancelled { return }
            outputArray.append(slowAdd(pair))
        }
    }
}
```

ì‘ì—… ì·¨ì†Œì— ë”°ë¥¸ ë™ì‘ì€ ì§ì ‘ ì •ì˜í•´ì¤˜ì•¼ í•œë‹¤. `isCancelled` ê°’ì— ë”°ë¥¸ ë¶„ê¸°ì²˜ë¦¬ ì½”ë“œë¥¼ í™•ì¸í•˜ì.

ì˜¤í¼ë ˆì´ì…˜ ì·¨ì†ŒëŠ” ì»¬ë ‰ì…˜ ë·° `didEndDisplaying` ë©”ì„œë“œì—ì„œ ì´ë¯¸ì§€ ë¡œë“œë¥¼ ë” ì´ìƒ í•˜ì§€ ì•Šì•„ë„ ë  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆê² ë‹¤.

:::

## Reference

1. [ì¸í”„ëŸ° - ì•¨ëŸ° ë™ì‹œì„± í”„ë¡œê·¸ë˜ë°](https://www.inflearn.com/course/iOS-Concurrency-GCD-Operation/dashboard)
2. [The thread safety of lazy variables in Swift](https://medium.com/what-i-talk-about-when-i-talk-about-ios-developmen/the-thread-safety-of-lazy-variables-in-swift-b20184ef5a38)
