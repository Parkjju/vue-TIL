---
title: Snack - [iOS] í‚¹í”¼ì…” ì´ë¯¸ì§€ ìºì‹± ê¸°ë°˜ì˜ í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ êµ¬í˜„ + RxSwift
tags: ['Snack', 'RxSwift', 'UIKit', 'Kingfisher', 'í¬ì¦ˆí”¼ì»¤ ê°œë°œ ì´ì•¼ê¸°']
---

í”„ë¡œì íŠ¸ í¬ì¦ˆí”¼ì»¤ ê°œë°œ ì´ì•¼ê¸°ì…ë‹ˆë‹¤! ê¶ê¸ˆí•˜ì‹œë‹¤ë©´ ë†€ëŸ¬ì™€ì£¼ì„¸ìš” :) [[í¬ì¦ˆí”¼ì»¤ ë‹¤ìš´ë°›ê¸°ğŸ”—]](https://apps.apple.com/kr/app/%ED%8F%AC%EC%A6%88%ED%94%BC%EC%BB%A4-%EB%84%A4%EC%BB%B7%EC%82%AC%EC%A7%84-%ED%8F%AC%EC%A6%88%EC%B6%94%EC%B2%9C/id6474260471)

# í‚¹í”¼ì…” ì´ë¯¸ì§€ ìºì‹± ê¸°ë°˜ì˜ í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ êµ¬í˜„ + RxSwift

## í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ

![34-1](../.vuepress/assets/snack/34-1.gif)

í•€í„°ë ˆìŠ¤íŠ¸ í™”ë©´ì„ ë³´ë©´ ì´ë¯¸ì§€ ê³ ìœ ì˜ ë¹„ìœ¨ê°’ì„ ìœ ì§€í•˜ë©´ì„œ ììœ ë¶„ë°©í•˜ê²Œ ë ˆì´ì•„ì›ƒ ë°°ì¹˜ë¥¼ ì§„í–‰í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ê°€ë¡œ ê°’ì€ ê¸°ê¸° ìì²´ í™”ë©´ ë„ˆë¹„ë¥¼ ë°˜ìœ¼ë¡œ ë‚˜ëˆˆ ê°’ìœ¼ë¡œ ê³ ì •í•˜ê³  ì´ ê°’ê³¼ ì´ë¯¸ì§€ ê³ ìœ ì˜ ê°€ë¡œ ì„¸ë¡œ ë¹„ìœ¨ì„ ë¹„êµí•˜ì—¬ ì„¸ë¡œê°’ì„ ë™ì ìœ¼ë¡œ ì‚°ì •í•˜ëŠ” ì‹ì˜ ë¡œì§ì´ë‹¤.

ì›¹ì˜ ê²½ìš° ê³„ì‚°ëœ ì´ë¯¸ì§€ë“¤ì„ í•˜ë‚˜ì”© ë¶™ì—¬ë„£ëŠ” ë°©ì‹ìœ¼ë¡œ ì‰½ê²Œ êµ¬í˜„ì´ ë˜ì§€ë§Œ ìŠ¤ìœ„í”„íŠ¸ì—ì„œëŠ” ìƒˆë¡œ ìƒê¸°ëŠ” ê°ì²´ë“¤ì„ ë™ì ìœ¼ë¡œ UIì— ë¶™ì´ë©´ì„œ ìŠ¤í¬ë¡¤ í˜•íƒœë¡œ ê¸°ì¡´ì˜ ì´ë¯¸ì§€ ë ˆì´ì•„ì›ƒì„ ì¬ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì„±ëŠ¥ì  ì´ìŠˆê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ë†í›„í•˜ë‹¤.

ë”°ë¼ì„œ ì»¬ë ‰ì…˜ ë·°ë¡œ í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒì„ êµ¬í˜„í•´ì•¼ë§Œ í•œë‹¤.

ì‹¤ì œ êµ¬í˜„ ê²°ê³¼ë¬¼ì„ ë¨¼ì € ì‚´í´ë³´ê³ , êµ¬í˜„ ê³¼ì •ì„ ì‚´í´ë³´ë„ë¡ í•˜ì.

![34-2](../.vuepress/assets/snack/34-2.gif)

ì½”ë“œ ìì²´ì— ëŒ€í•œ ì‘ì„±ì´ë‚˜ ì„¤ëª…ì€ [ë‹¤ìŒ ë§í¬](https://www.kodeco.com/4829472-uicollectionview-custom-layout-tutorial-pinterest)ì— ê°€ì¥ ìì„¸íˆ ë‚˜ì™€ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ì.

ì—¬íƒ€ ë‹¤ë¥¸ ë¸”ë¡œê·¸ë“¤ì´ ìœ„ì˜ ê¸€ì„ ì›ë³¸ìœ¼ë¡œ í•˜ì—¬ ì •ë¦¬í•´ë‘” ê²ƒì´ ì¼ë°˜ì ì¸ ëª¨ìŠµì´ë¼ ì´ ê¸€ì—ì„œëŠ” ì½”ë“œì˜ íë¦„ ì •ë„ë§Œ ì§šì–´ë³´ê³  ì´ë¯¸ì§€ ìºì‹œ ì²˜ë¦¬ì™€ ì—®ì—ˆì„ë•Œ ë°œìƒí•˜ëŠ” ë¬¸ì œì ì„ ì¤‘ì ì ìœ¼ë¡œ í†ºì•„ë³´ë ¤ í•œë‹¤.

## ì´ë¯¸ì§€ ê³ ìœ ì‚¬ì´ì¦ˆ ê³„ì‚°

`UIScreen.main.bounds.width`ë¥¼ í™œìš©í•˜ë©´ ê¸°ê¸°ë³„ ë„ˆë¹„ê°’ì„ ì–»ì„ ìˆ˜ ìˆë‹¤. ì»¬ë ‰ì…˜ë·° ì¢Œìš° íŒ¨ë”©ê°’ê³¼ ì´ë¯¸ì§€ ì‚¬ì´ í‹ˆìƒˆê°’ ëª¨ë‘ ìƒìˆ˜ í˜•íƒœë¡œ ê³ ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì´ë¯¸ì§€ ë„ˆë¹„ê°’ë„ ê³ ì •ëœë‹¤.

![34-3](../.vuepress/assets/snack/34-3.jpeg)

ì¦‰ ìœ„ ê·¸ë¦¼ì„ í† ëŒ€ë¡œ ê³ ì •ëœ ì´ë¯¸ì§€ í•˜ë‚˜ì˜ ë„ˆë¹„ê°’ì„ ê³„ì‚°í•˜ë©´ `(UIScreen.main.bounds.width - (imagePadding * 2) - imageSpacing) / 2`ì˜ ê°’ì„ ê°–ê²Œ ëœë‹¤.

ê³ ì •ëœ ë„ˆë¹„ ìƒìˆ˜ê°’ì´ ìˆê³  ì´ë¯¸ì§€ ê³ ìœ  ì‚¬ì´ì¦ˆì— ëŒ€í•œ ë¹„ìœ¨ ì—­ì‹œ ê³„ì‚°í•  ìˆ˜ ìˆë‹¤. ì´ë¡œë¶€í„° ì„¸ë¡œ ê¸¸ì´ë¥¼ ë„ì¶œí•˜ê¸° ìœ„í•´ì„œëŠ” ì•„ë˜ì™€ ê°™ì€ í•¨ìˆ˜ë¥¼ ì‘ì„±í•´ë³¼ ìˆ˜ ìˆë‹¤.

```swift
func newSizeImageWidthDownloadedResource(image: UIImage) -> UIImage {
    let targetWidth = (UIScreen.main.bounds.width - 56) / 2 // ì´ë¯¸ì§€ í•˜ë‚˜ì˜ ë„ˆë¹„
    let newSizeImage = image.resize(newWidth: targetWidth) // UIImage ë¦¬ì‚¬ì´ì§• ìµìŠ¤í…ì…˜ í•¨ìˆ˜
    return newSizeImage
}

// UIImage+.swift
// UIImage ìµìŠ¤í…ì…˜
func resize(newWidth: CGFloat) -> UIImage {
    let scale = newWidth / self.size.width // ê°€ë¡œ ë¹„ ê³„ì‚°
    let newHeight = self.size.height * scale // ë¹„ìœ¨ ê¸°ì¤€ìœ¼ë¡œ ìƒˆë¡œ ë„ì¶œëœ ë†’ì´ê°’ ê³„ì‚°

    let size = CGSize(width: newWidth, height: newHeight)
    let render = UIGraphicsImageRenderer(size: size)
    let renderImage = render.image { context in
        self.draw(in: CGRect(origin: .zero, size: size))
    } // ì •ì˜ëœ ê°€ë¡œ ì„¸ë¡œê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì´ë¯¸ì§€ redraw
    return renderImage
}
```

ìœ„ ê³¼ì •ì„ ê±°ì¹˜ê³  ë‚˜ë©´ ê¸°ë³¸ `UICollectionViewFlowLayout`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°°ì¹˜ë¥¼ í–ˆì„ë•Œ ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ë¬¼ì´ ë‚˜íƒ€ë‚œë‹¤.

## ì»¤ìŠ¤í…€ ë ˆì´ì•„ì›ƒ êµ¬í˜„

iOSì—ì„œ ì»¬ë ‰ì…˜ë·° êµ¬ì„±ì„ ìœ„í•´ì„œëŠ” `UICollectionView` ì…€ ë“±ë¡ê³¼ ê°™ì€ ê°ì²´ ìì²´ì— ëŒ€í•œ ì„¤ì •ë“¤ë„ í•„ìš”í•˜ì§€ë§Œ ê·¸ë§Œí¼ ì¤‘ìš”í•œ ê²ƒì´ ë ˆì´ì•„ì›ƒ ê°ì²´ë¥¼ ì „ë‹¬í•˜ëŠ” ê²ƒì´ë‹¤. ë³´í†µì˜ ê²½ìš° `itemSize`ë‚˜ ì•„ì´í…œê°„ ê°„ê²©ì— ëŒ€í•œ ìˆ˜ì¹˜ë“¤ì„ ì „ë‹¬í•˜ì—¬ ê¸°ë³¸ `UICollectionViewFlowLayout`ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒì˜ ê²½ìš° ì™„ì „íˆ ì»¤ìŠ¤í…€ì„ ì§„í–‰í•œ ë ˆì´ì•„ì›ƒ ê°ì²´ì´ë‹¤.

ì»¬ë ‰ì…˜ë·°ë‚˜ í…Œì´ë¸” ë·°ì˜ ë ˆì´ì•„ì›ƒì„ ì»¤ìŠ¤í…€í•˜ê³ ì í• ë•Œ ê°€ì¥ ë¨¼ì € ìƒê°í•´ì•¼í•  ê²ƒì€ ì‹œìŠ¤í…œ ë‚´ë¶€ì ìœ¼ë¡œ ë ˆì´ì•„ì›ƒ ê³„ì‚°ì´ ì™„ì „íˆ ëë‚œ ì‹œì ì— í•´ë‹¹ ë ˆì´ì•„ì›ƒ ìˆ˜ì¹˜ë“¤ì„ ì´ˆê¸°í™”í•˜ê³  í•˜ë‚˜ë¶€í„° ì—´ê¹Œì§€ ë°°ì¹˜ë¥¼ ì§ì ‘ í•œë‹¤ëŠ” ê²ƒì´ë‹¤.

ì´ë¯¸ì§€ ê³ ìœ  ì‚¬ì´ì¦ˆ ë¹„ìœ¨ë¡œ ë¦¬ì‚¬ì´ì§•ì„ ì§„í–‰í•œ ë’¤ `UICollectionViewFlowLayout` ê¸°ë³¸ ê°ì²´ë¡œ ì»¬ë ‰ì…˜ë·° ë ˆì´ì•„ì›ƒ ë°°ì¹˜ë¥¼ ì§€ì‹œí•˜ê²Œ ë˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í™”ë©´ì´ ë‚˜íƒ€ë‚˜ê²Œ ëœë‹¤.

![34-4](../.vuepress/assets/snack/34-4.png)

ì»¬ë ‰ì…˜ë·°ëŠ” ë§Œì•½ `vertical` ìŠ¤í¬ë¡¤ì„ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•œë‹¤ê³  ê°€ì •í–ˆì„ë•Œ ê°™ì€ í–‰ì— ìœ„ì¹˜í•œ ë·°ì˜ í¬ê¸° ì°¨ì´ê°€ ë‚ ë•Œ **ë” ì‚¬ì´ì¦ˆê°€ í° ë·°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ì•™ì •ë ¬ ì²˜ë¦¬ë¥¼ í•œë‹¤.** ì˜¤ë¥¸ìª½ ì´ë¯¸ì§€ì˜ ì‚¬ì´ì¦ˆê°€ ë” í¬ê¸° ë•Œë¬¸ì— ì™¼ìª½ ì´ë¯¸ì§€ê°€ ì˜¤ë¥¸ì¡± ì´ë¯¸ì§€ì˜ `centerY`ê°’ìœ¼ë¡œ ìë™ ë§ì¶¤ì´ ì´ë£¨ì–´ì§„ ê²ƒì´ë‹¤.

ì»¤ìŠ¤í…€ ë ˆì´ì•„ì›ƒ ë°°ì¹˜ë¥¼ í•˜ê¸° ìœ„í•´ì„œëŠ” `UICollectionViewFlowLayout`ë¥¼ ìƒì†ë°›ëŠ” í´ë˜ìŠ¤ë¥¼ ìƒˆë¡­ê²Œ ì •ì˜í•´ì•¼ í•œë‹¤. ì»¬ë ‰ì…˜ë·° ë ˆì´ì•„ì›ƒ í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ì€ í˜•íƒœì´ê¸° ë•Œë¬¸ì— ì°¸ì¡°í•˜ê³  ìˆëŠ” ì»¬ë ‰ì…˜ë·° ê°ì²´ë„ ì–»ì–´ì˜¬ ìˆ˜ ìˆë‹¤.

ì´ë•Œ ì»¬ë ‰ì…˜ë·° ê°ì²´ì—ì„œ ì œê³µí•˜ëŠ” `collectionView.numberOfItems(inSection: Int)` ë©”ì„œë“œë¥¼ í†µí•´ ì„¹ì…˜ë³„ ì…€ ê°¯ìˆ˜ë¥¼ ì–»ì„ ìˆ˜ ìˆê³  ì…€ì„ í•˜ë‚˜ì”© ìˆœíšŒí•˜ë©° `offset`ê°’ì„ ì§ì ‘ ì¡°ì •í•´ì£¼ëŠ” íë¦„ì„ ê°–ëŠ”ë‹¤.

![34-5](../.vuepress/assets/snack/34-5.jpg)

ì½”ë“œ ì£¼ì„ì„ ì˜ ì°¸ì¡°í•˜ë©´ í™”ë©´ êµ¬í˜„ ìì²´ì— ì–´ë ¤ì›€ì€ ì—†ë‹¤.

## í•€í„°ë ˆìŠ¤íŠ¸ ë¸ë¦¬ê²Œì´íŠ¸

í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ ì½”ë“œì˜ ê°€ì¥ ì¤‘ìš”í•œ ì ì€ ë ˆì´ì•„ì›ƒ êµ¬ì„± ì½”ë“œ ìì²´ë„ ìˆì§€ë§Œ, ë ˆí¼ëŸ°ìŠ¤ì— ë‚˜ì™€ìˆë“¯ **ì»¤ìŠ¤í…€ ë¸ë¦¬ê²Œì´íŠ¸ ê°ì²´ê°€** ì •ë§ ì¤‘ìš”í•˜ë‹¤.

```swift
protocol PinterestLayoutDelegate: AnyObject {
    func collectionView(_ collectionView: UICollectionView, heightForPhotoAtIndexPath indexPath: IndexPath) -> CGFloat
}
```

ìœ„ì˜ ë¸ë¦¬ê²Œì´íŠ¸ ë©”ì„œë“œëŠ” ì…€ ìˆœíšŒ ê³¼ì •ì—ì„œ `indexPath`ë¥¼ í†µí•´ ì…€ ì»¨í…ì¸ ì˜ ë†’ì´ë¥¼ ë°˜í™˜í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

```swift
for item in 0..<collectionView.numberOfItems(inSection: 0) {
    // IndexPath ì— ë§ëŠ” ì…€ì˜ í¬ê¸°, ìœ„ì¹˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
    let indexPath = IndexPath(item: item, section: 0)
    let imageHeight = delegate?.collectionView(collectionView, heightForPhotoAtIndexPath: indexPath) ?? 180
    // .....
    // .....
}
```

í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ ê°ì²´ëŠ” ì†ì„±ê°’ìœ¼ë¡œ `yOffSet`ì„ ê°–ëŠ”ë‹¤. ì»¬ëŸ¼ ìˆ˜ ë§Œí¼ ë°°ì—´ ì›ì†Œ ìˆ˜ë¥¼ í• ë‹¹ë°›ëŠ”ë‹¤. í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒì˜ ê²½ìš° ì»¬ëŸ¼ ìˆ˜ê°€ ë‘ê°œì´ë¯€ë¡œ ì´ˆê¸° offsetê°’ì´ 1ë²ˆì§¸, 2ë²ˆì§¸ ì»¬ëŸ¼ ë§ˆì§€ë§‰ ì˜¤í”„ì…‹ ê°’ì´ `[0, 0]`ìœ¼ë¡œ ì§€ì •ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

```swift
var yOffSet: [CGFloat] = .init(repeating: 0, count: numberOfColumns)
```

ì…€ì„ ìˆœíšŒí•˜ë©° ë†’ì´ê°’ê³¼ ì´ë¯¸ì§€ ì‚¬ì´ íŒ¨ë”©ê°’ì˜ í•©ì„ offset ì»¬ëŸ¼ ìœ„ì¹˜ì— ë”í•´ì£¼ëŠ” í˜•íƒœë¡œ ë ˆì´ì•„ì›ƒ ë°°ì¹˜ë¥¼ ì§„í–‰í•˜ëŠ” ê²ƒì´ë‹¤.

ë·° ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì»¬ë ‰ì…˜ë·° ê° ì…€ ë‚´ë¶€ ì»¨í…ì¸ ë“¤ì„ ë³´í†µ ë°°ì—´ í˜•íƒœë¡œ ê°€ì§€ê³  ìˆì„í…ë°, ì´ ë°ì´í„°ë“¤ì„ í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ ê°ì²´ì— ì „ë‹¬í•˜ì—¬ ê° `indexPath`ì—ì„œ ì‚¬ì´ì¦ˆë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œ ë˜ëŠ” ê²ƒì´ë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ ìœ„ì˜ `UIImage` ìµìŠ¤í…ì…˜ í•¨ìˆ˜ì¸ `resize`ë¡œ ìƒì„±ëœ ì´ë¯¸ì§€ì˜ `size`í”„ë¡œí¼í‹°ë¥¼ ì°¸ì¡°í•˜ì—¬ ë†’ì´ê°’ì„ ë°°ì—´ë¡œ ì¶”ì¶œí•œ ë’¤ í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒì— ì „ë‹¬í•˜ë©´ í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ ê°ì²´ê°€ ë°°ì¹˜ ê³¼ì •ì—ì„œ ë‚´ë¶€ì˜ ê°’ì„ ì ì ˆíˆ ì •ë¦¬í•œë‹¤ëŠ” ê²ƒì´ë‹¤.

## í‚¹í”¼ì…” ì´ë¯¸ì§€ ìºì‹± + RxSwift

êµ¬í˜„ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ì‚´í´ë³´ì.

![34-2](../.vuepress/assets/snack/34-2.gif)

ìŠ¤í¬ë¡¤ ê³¼ì •ì—ì„œ ì´ë¯¸ì§€ë“¤ì´ ê³„ì†í•´ì„œ ë¡œë“œë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ìš°ì„  ì´ë¯¸ì§€ëŠ” ì„œë²„ë¡œë¶€í„° ì´ë¯¸ì§€ ë°ì´í„° ìì²´ë¥¼ ì „ë‹¬ë°›ëŠ” ê²ƒì´ ì•„ë‹Œ ì•„ë§ˆì¡´ `S3`ì— ì €ì¥ëœ URLì„ ì „ë‹¬ë°›ëŠ”ë‹¤. ì´ë¯¸ì§€ë“¤ì€ URL ë¬¸ìì—´ê°’ì„ ê°€ì§€ê³  `URL ê°ì²´ë¥¼` ìƒì„±í•œ ë’¤ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë¥¼ ë°›ê±°ë‚˜(ë‹¤ìš´ë¡œë“œ ë°›ì€ ì´ë¯¸ì§€ëŠ” URLì„ í‚¤ê°’ìœ¼ë¡œ í•œ ë’¤ ìºì‹±ëœë‹¤) URL ë¬¸ìì—´ì„ í‚¤ê°’ìœ¼ë¡œ í•˜ì—¬ ìºì‹œ ì €ì¥ì†Œì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ê²Œ ëœë‹¤.

ì´ë•Œ ì´ë¯¸ì§€ë“¤ì˜ ë†’ì´ê°’ì„ í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒì— ì „ë‹¬í•´ì•¼ í•˜ëŠ”ë° ì…€ì— ë°”ì¸ë”©í•  `UIImage` ê°ì²´ ìì²´ë¥¼ ë°°ì—´ì— ë§¤ë²ˆ ì €ì¥í•˜ê³  ì—…ë°ì´íŠ¸ í•˜ëŠ” ë“±ì˜ ë¡œì§ì„ ì²˜ë¦¬í•˜ê²Œ ë˜ë©´ ì•± ìì²´ì˜ ë¬´ê²Œê°€ ë¬´ê±°ì›Œì§€ê¸° ë•Œë¬¸ì—, ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆê°’ë§Œ ë·°ëª¨ë¸ ê°ì²´ ì†ì„±ê°’ìœ¼ë¡œ ì¶”ê°€í•˜ì—¬ ê´€ë¦¬í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ì˜€ë‹¤.

í˜ì´ì§€ ë‹¹ ë¶ˆëŸ¬ì˜¬ ì´ë¯¸ì§€ ìˆ˜ê°€ 10ê°œë¼ê³  ê°€ì •í–ˆì„ë•Œ í˜ì´ì§€ ì „ì²´ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¨ ì´í›„ì— RxCocoaì˜ ì»¬ë ‰ì…˜ë·° `items`ë©”ì„œë“œë¥¼ í†µí•´ UI ë°”ì¸ë”©ì„ ì§„í–‰í•œë‹¤. í‚¹í”¼ì…” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ì‘ì„±í•œ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```swift
func retrieveCacheObservable(posefeed: [PosePick]) -> Observable<[PoseFeedPhotoCellViewModel]> {
    let viewModelObservable = BehaviorRelay<[PoseFeedPhotoCellViewModel]>(value: [])

    posefeed.forEach { posepick in
        ImageCache.default.retrieveImage(forKey: posepick.poseInfo.imageKey, options: nil) { [weak self] result in
            guard let self = self else { return }
            switch result {
            case .success(let value):
                if let image = value.image {
                    let newSizeImage = self.newSizeImageWidthDownloadedResource(image: image) // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§•
                    self.filteredContentSizes.accept(self.filteredContentSizes.value + [newSizeImage.size]) // ì‚¬ì´ì¦ˆ ë°°ì—´ì— ì—…ë°ì´íŠ¸ ëœ ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆ ì¶”ê°€

                    let viewModel = PoseFeedPhotoCellViewModel(image: newSizeImage, poseId: posepick.poseInfo.poseId)
                    viewModelObservable.accept(viewModelObservable.value + [viewModel]) // ë·°ëª¨ë¸ ì˜µì €ë²„ë¸” next ë°©ì¶œ
                } else {
                    guard let url = URL(string: posepick.poseInfo.imageKey) else { return } // URL ê°ì²´ ìƒì„±

                    KingfisherManager.shared.retrieveImage(with: url) { downloadResult in // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                        switch downloadResult {
                        case .success(let downloadImage):
                            let newSizeImage = self.newSizeImageWidthDownloadedResource(image: downloadImage.image)
                            self.filteredContentSizes.accept(self.filteredContentSizes.value + [newSizeImage.size]) // ì‚¬ì´ì¦ˆ ë°°ì—´ì— ì—…ë°ì´íŠ¸ ëœ ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆ ì¶”ê°€

                            let viewModel = PoseFeedPhotoCellViewModel(image: newSizeImage, poseId: posepick.poseInfo.poseId)
                            viewModelObservable.accept(viewModelObservable.value + [viewModel]) // ë·°ëª¨ë¸ ì˜µì €ë²„ë¸” next ë°©ì¶œ
                        case .failure:
                            return
                        }
                    }
                }
            case .failure:
                return
            }
        }
    }
    // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ê°¯ìˆ˜ë§Œí¼ skipí•˜ê³  ìµœì¢… ë°©ì¶œ
    return viewModelObservable.asObservable().skip(while: { $0.count < posefeed.count })
}
```

`PosePick`ì€ ì„œë²„ì—ì„œ ì œê³µí•´ì¤€ APIë¥¼ ë”°ë¼ ì§ì ‘ ì‘ì„±í•œ ëª¨ë¸ì´ë‹¤. í¬ì¦ˆí”½ ëª¨ë¸ ë‚´ì— ì´ë¯¸ì§€ URL ì •ë³´ê°€ ë‹´ê²¨ìˆì–´ í•´ë‹¹ ê°’ì„ ê°€ì§€ê³  ìºì‹œë¡œë¶€í„° ì´ë¯¸ì§€ ë¡œë“œ ì‘ì—…ì„ ì§„í–‰í•œë‹¤.

1. `ImageCache.default.retrieveImage(forKey: ì´ë¯¸ì§€ URL)` ë©”ì„œë“œë¥¼ í†µí•´ ìºì‹œ ì €ì¥ì†Œì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤.
2. `retrieveImage` í•¨ìˆ˜ëŠ” ì»´í”Œë¦¬ì…˜ í•¸ë“¤ëŸ¬ íŒŒë¼ë¯¸í„°ì— ì½œë°±í•¨ìˆ˜ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆëŠ”ë°, ì½œë°±í•¨ìˆ˜ì˜ ì¸ìê°’ìœ¼ë¡œëŠ” `Result`íƒ€ì…ì˜ ê°ì²´ê°€ ì „ë‹¬ëœë‹¤.
3. switch caseë¬¸ìœ¼ë¡œ ë¶„ê¸°ì²˜ë¦¬ë¥¼ í•˜ê²Œë˜ë©° `KingfisherError`ì— í•´ë‹¹í•˜ì§€ ì•ŠëŠ” í•œ success ì¼€ì´ìŠ¤ ë‚´ì— valueê°’ì„ ê°€ì§€ê³  ë‹¤ì‹œ í•œë²ˆ ë¶„ê¸°ì²˜ë¦¬ë¥¼ ì§„í–‰í•˜ê²Œ ëœë‹¤.
4. `value` ê°ì²´ ë‚´ì—ëŠ” `image`ì†ì„±ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ë°, `KFCrossPlatformImage?` íƒ€ì…ì„ ê°–ëŠ”ë‹¤. `if let` ë°”ì¸ë”©ìœ¼ë¡œ ì´ë¯¸ì§€ ì¶”ì¶œì´ ì´ë£¨ì–´ì§€ë©´ ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§•ì„ ì§„í–‰í•˜ê³  ìƒˆë¡œ ìƒì„±ëœ ì´ë¯¸ì§€ ë†’ì´ê°’ì„ ë·°ëª¨ë¸ ì†ì„±ê°’ ë°°ì—´ì— ì¶”ê°€í•œë‹¤.
5. ì´ë•Œ ìƒì„±í•˜ëŠ” ëª¨ë“  ì´ë¯¸ì§€ ë†’ì´ê°’ì„ ë·°ëª¨ë¸ ê°ì²´ì˜ ì‚¬ì´ì¦ˆ ë°°ì—´ì— ì¶”ê°€í•œë‹¤.
6. ë§Œì•½ ì´ë¯¸ì§€ `if let` ë°”ì¸ë”©ì— ì‹¤íŒ¨í•œ ê²½ìš° ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ì•„ì•¼ í•œë‹¤. ì´ë¯¸ì§€ urlì„ swift `URL`ê°ì²´ë¡œ ìƒì„±í•œ ë’¤ `KingfisherManager.shared.retrieveImage(with: url)` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê³  ì»´í”Œë¦¬ì…˜ í•¸ë“¤ëŸ¬ì—ì„œ í•œë²ˆ ë” switch - case ë¶„ê¸°ì²˜ë¦¬ë¥¼ ì§„í–‰í•œë‹¤.

ìºì‹œì—ì„œ ë¡œë“œëœ ì´ë¯¸ì§€ë“¤ì€ ê·¸ ì¦‰ì‹œ ì»¬ë ‰ì…˜ë·° ì…€ ì•„ì´í…œìœ¼ë¡œ ë°”ì¸ë”© ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì´ˆê¸°ì— APIë¡œ ì „ë‹¬ëœ URLê°¯ìˆ˜ë§Œí¼ ì´ë¯¸ì§€ ë¡œë“œê°€ ëë‚ ë•Œê¹Œì§€ `skip` ì—°ì‚°ìë¡œ ëŒ€ê¸°í–ˆë‹¤ê°€ í•˜ë‚˜ì˜ ì˜µì €ë²„ë¸”ë¡œ ìµœì¢… ë°©ì¶œë˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ëœë‹¤.

í•œ ë²ˆì— ë°©ì¶œí•´ì•¼ ì»¬ë ‰ì…˜ë·° ë¦¬ë¡œë”©ì˜ íšŸìˆ˜ë„ ì ì–´ì§€ê³  ê·¸ë§Œí¼ ë ˆì´ì•„ì›ƒ ê³„ì‚°ë„ íš¨ìœ¨ì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸ì´ë‹¤.

ìœ„ì˜ `retrieveCacheObservable` í•¨ìˆ˜ë¥¼ ì‹¤ì œë¡œ ì‚¬ìš©í•˜ëŠ” ì˜ˆì‹œ ì½”ë“œë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

```swift
input.triggerObservable
    .flatMapLatest { [unowned self] _ -> Observable<PoseFeed> in
        loadable.accept(true)
        return self.apiSession.requestSingle(.retrieveAllPoseFeed(pageNumber: self.currentPage, pageSize: 8)).asObservable()
    }
    .flatMapLatest { [unowned self] posefeed -> Observable<[PoseFeedPhotoCellViewModel]> in
        return self.retrieveCacheObservable(posefeed: posefeed)
    }
    .subscribe(onNext: {
        loadable.accept(false)
        filterSection.accept($0) // ì„¹ì…˜ ì˜µì €ë²„ë¸”ì— ì´ë¯¸ì§€ë°ì´í„° ë°©ì¶œ
    })
    .disposed(by: disposeBag)
// ...
```

`triggerObservable`ì— next ì´ë²¤íŠ¸ê°€ ë°©ì¶œë˜ì—ˆì„ë•Œ `flatMapLatest` ì˜¤í¼ë ˆì´í„°ë¥¼ í†µí•´ ì´ë¯¸ì§€ ìºì‹± ì˜µì €ë²„ë¸”ì„ ë¦¬í„´í•˜ëŠ”ë° ë¬´í•œ ìŠ¤í¬ë¡¤ í˜ì´ì§€ë„¤ì´ì…˜ì˜ ê° í˜ì´ì§€ë³„ ì‚¬ì´ì¦ˆê°’ë§Œí¼ ì´ë¯¸ì§€ ë¡œë“œê°€ ëë‚ ë•Œê¹Œì§€ `skip`í•˜ê³  ìµœì¢… ë¡œë“œê°€ ëë‚¬ì„ë•Œ ë‹¤ìŒ ì‘ì—…ìœ¼ë¡œ ë„˜ì–´ê°„ë‹¤.

`filterSection`ì´ë¼ëŠ” ì˜µì €ë²„ë¸”ì— ë¡œë“œê°€ ëë‚œ ì´ë¯¸ì§€ ì „ì²´ë¥¼ ë·°ëª¨ë¸ë¡œ ë˜í•‘í•˜ì—¬ ì „ë‹¬í•˜ëŠ” ì‹ìœ¼ë¡œ í˜„ì¬ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë©° ë°ì´í„° ì „ë‹¬ê³¼ í•¨ê»˜ ì»¬ë ‰ì…˜ë·°ê°€ í•œ ë²ˆì— ë¦¬ë¡œë”© ë˜ë©° í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒì´ êµ¬í˜„ëœë‹¤.

ìºì‹œ ì—…ë°ì´íŠ¸ ê³¼ì •ì—ì„œ ë§Œë“¤ì–´ì§„ ì´ë¯¸ì§€ ë†’ì´ê°’ ë°°ì—´ì€ ë·°ëª¨ë¸ ë‚´ì— ì €ì¥ë˜ê³  ë·° ì»¨íŠ¸ë¡¤ëŸ¬ ë¸ë¦¬ê²Œì´íŠ¸ êµ¬í˜„ì²´ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œë¥¼ í†µí•´ ë·°ëª¨ë¸ì„ ì°¸ì¡°í•˜ê²Œ ëœë‹¤. ì•„ë˜ ì½”ë“œëŠ” ì„¹ì…˜ë³„ë¡œ ë¶„ë¦¬ëœ ì»¨í…ì¸ ë¡œ ì¸í•´ ì‘ì„±ëœ ê²ƒì´ë‹¤.

```swift
extension PoseFeedViewController: PinterestLayoutDelegate {
    func collectionView(_ collectionView: UICollectionView, heightForPhotoAtIndexPath indexPath: IndexPath) -> CGFloat {
        if indexPath.section == 0 {
            return viewModel.filteredContentSizes.value[indexPath.item].height
        } else {
            return viewModel.recommendedContentsSizes.value[indexPath.item].height
        }
    }
}
```

:::warning prepare ë©”ì„œë“œ

`retrieveCacheObservable`ì„ í†µí•´ ìºì‹œì—ì„œ ì´ë¯¸ì§€ ë°ì´í„° ë¡œë“œê°€ ëë‚˜ë©´ ì»¬ë ‰ì…˜ë·°ì—ì„œ ë¦¬ë¡œë”© ì‘ì—…ì´ ì§„í–‰ë˜ë„ë¡ ë¡œì§ êµ¬í˜„ì´ ë˜ì–´ìˆëŠ”ë° í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ ê°ì²´ëŠ” ë ˆì´ì•„ì›ƒì˜ ë¶ˆí•„ìš”í•œ ì¬ê³„ì‚°ì´ ì´ë£¨ì–´ì§€ì§€ ì•Šê²Œë” ì»¬ë ‰ì…˜ë·° ë ˆì´ì•„ì›ƒ ì–´íŠ¸ë¦¬ë·°íŠ¸ ê°ì²´ë“¤ì„ ìºì‹±í•˜ê³  ìˆë‹¤.

```swift
private var cache: [UICollectionViewLayoutAttributes] = []
```

ê° ì…€ì˜ ë ˆì´ì•„ì›ƒ ì†ì„±ë“¤ì„ í•´ë‹¹ ë°°ì—´ì— ì¶”ê°€í•œ ë’¤ ë‹¤ìŒ ì˜¤ë²„ë¼ì´ë”© í•¨ìˆ˜ê°€ ë‚´ë¶€ì ìœ¼ë¡œ í˜¸ì¶œë˜ë©´ ë ˆì´ì•„ì›ƒ ë°°ì¹˜ê°€ ë§ˆë¬´ë¦¬ëœë‹¤.

```swift
override func layoutAttributesForItem(at indexPath: IndexPath) -> UICollectionViewLayoutAttributes? {
    return cache[indexPath.item]
}
```

ìœ„ í•¨ìˆ˜ëŠ” ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ë‚´ë¶€ì ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ì´ë‹¤. ë¬¸ì œëŠ” ì´ëŸ¬í•œ ë ˆì´ì•„ì›ƒ ìºì‹± ì‘ì—…ìœ¼ë¡œ ì¸í•´ **ë¬´í•œìŠ¤í¬ë¡¤ì„ í†µí•´ ì¶”ê°€ë˜ëŠ” ì…€ë“¤ì— ëŒ€í•œ ì–´íŠ¸ë¦¬ë·°íŠ¸ ê³„ì‚°ì´ë‚˜** ì´ë¯¸ì§€ë°ì´í„° ì´ˆê¸°í™” ë“±ì˜ ìƒí™©ì—ì„œ ë ˆì´ì•„ì›ƒ ìˆ˜ì¹˜ë“¤ì´ ê¼¬ì—¬ë²„ë¦´ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.

ë”°ë¼ì„œ ì»¬ë ‰ì…˜ë·° ë‚´ë¶€ì ìœ¼ë¡œ ë¦¬ë¡œë”© ë  ë•Œì— `prepare` ë©”ì„œë“œê°€ í˜¸ì¶œë˜ëŠ”ë° ì´ë•Œë§ˆë‹¤ ê¸°ì¡´ ìºì‹±ëœ ë ˆì´ì•„ì›ƒ ìˆ˜ì¹˜ë“¤ì„ ì´ˆê¸°í™” í•˜ë„ë¡ ì½”ë“œë¥¼ ìƒˆë¡­ê²Œ ì‘ì„±í•´ì¤˜ì•¼ í•œë‹¤.

```swift
override func prepare() {
    cache.removeAll() // ë ˆì´ì•„ì›ƒ ìºì‹œ ìˆ˜ì¹˜ ì „ë¶€ ë¹„ìš°ê¸°
    contentHeight = 0 // ì»¬ë ‰ì…˜ë·° ì»¨í…ì¸  ë†’ì´ê°’ ì´ˆê¸°í™”
    // ...
    // ...
}
```

:::

## ìµœì¢… ì •ë¦¬

í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒê³¼ í‚¹í”¼ì…” ë¹„ë™ê¸° ì´ë¯¸ì§€ ë¡œë“œ êµ¬í˜„ì„ ìœ„í•œ íë¦„ì„ ì •ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

1. ì´ë¯¸ì§€ì˜ ë„ˆë¹„ê°’ì´ ê³ ì •ë˜ì–´ ìˆë‹¤ë©´ ì´ë¯¸ì§€ ê³ ìœ  ì‚¬ì´ì¦ˆë¡œë¶€í„° ë¹„ìœ¨ì„ ê³„ì‚°í•œ ë’¤ ë†’ì´ê°’ì„ ë™ì ìœ¼ë¡œ êµ¬í•œë‹¤.
2. ê³„ì‚°ëœ ë†’ì´ê°’ì€ ë·°ëª¨ë¸ ë‚´ì— ë°°ì—´ë¡œ ì¶”ê°€í•œë‹¤.
3. í•€í„°ë ˆìŠ¤íŠ¸ ë¸ë¦¬ê²Œì´íŠ¸ í”„ë¡œí† ì½œ êµ¬í˜„ í•¨ìˆ˜ ë‚´ì—ì„œ `indexPath`ê°ì²´ë¥¼ í†µí•´ ì´ë¯¸ì§€ ë†’ì´ê°’ì„ ì°¸ì¡°í•œë‹¤.
4. í•€í„°ë ˆìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ ë¸ë¦¬ê²Œì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ ì‹œì ì€ ì»¬ë ‰ì…˜ë·° ê°ì²´ì˜ ë¦¬ë¡œë“œ ì‹œì ì¸ë°, ë¦¬ë¡œë“œ íšŸìˆ˜ë¥¼ ìµœì†Œí™” í•˜ê¸° ìœ„í•´ í˜ì´ì§€ë„¤ì´ì…˜ í˜ì´ì§€ ì‚¬ì´ì¦ˆë§Œí¼ ì´ë¯¸ì§€ ë¡œë“œê°€ ëë‚ ë•Œê¹Œì§€ ì˜µì €ë²„ë¸” ì´ë²¤íŠ¸ ë°©ì¶œì„ `skip`í•œë‹¤.

## Reference

1. [Kodeco - UICollectionView Custom Layout Tutorial: Pinterest](https://www.kodeco.com/4829472-uicollectionview-custom-layout-tutorial-pinterest)
