---
title: Snack 44í˜¸ - í¬ì¦ˆí”¼ì»¤ í”„ë¡œì íŠ¸ í´ë¦° ì•„í‚¤í…ì²˜ ì ìš©ê¸°
tags: ['Snack', 'Clean Architecture', 'í¬ì¦ˆí”¼ì»¤ ê°œë°œ ì´ì•¼ê¸°']
---

í”„ë¡œì íŠ¸ í¬ì¦ˆí”¼ì»¤ ê°œë°œ ì´ì•¼ê¸°ì…ë‹ˆë‹¤! ê¶ê¸ˆí•˜ì‹œë‹¤ë©´ ë†€ëŸ¬ì™€ì£¼ì„¸ìš” :) [[í¬ì¦ˆí”¼ì»¤ ë‹¤ìš´ë°›ê¸°ğŸ”—]](https://apps.apple.com/kr/app/%ED%8F%AC%EC%A6%88%ED%94%BC%EC%BB%A4-%EB%84%A4%EC%BB%B7%EC%82%AC%EC%A7%84-%ED%8F%AC%EC%A6%88%EC%B6%94%EC%B2%9C/id6474260471)

## ê°œìš”

í”„ë¡œì íŠ¸ íŒ€ì›ë¶„ë“¤ì€ ì ˆëŒ€ ë³´ì±„ì‹œì§€ ì•Šìœ¼ì…¨ì§€ë§Œ.. ì–´ì©Œë‹¤ ë³´ë‹ˆ ë„ˆë¬´ ë¹ ë¥¸ í˜¸í¡ìœ¼ë¡œ ê°œë°œì´ ì§„í–‰ë˜ì–´ ì •ë§ ëˆˆì— ë³´ì´ëŠ” ê²ƒì—ë§Œ ì§‘ì¤‘ëœ ê°œë°œì„ í•˜ê²Œ ë˜ì—ˆë‹¤. ìœ ì§€ë³´ìˆ˜ë‚˜ ì•± ì „ì²´ì ì¸ êµ¬ì¡°ëŠ” í¬ê²Œ ê³ ë ¤í•˜ì§€ ì•Šê³  ê¸°ëŠ¥ êµ¬í˜„ ì¤‘ì‹¬ìœ¼ë¡œ ê°œë°œì„ ì§„í–‰í–ˆëŠ”ë°, ê·¸ëŸ¬ë‹¤ ë³´ë‹ˆ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±ì€ ë¬¼ë¡ ì´ê±°ë‹ˆì™€ ì•„ë˜ì™€ ê°™ì€ ë¬¸ì œë„ ë°œìƒí–ˆë‹¤.

![44-1](../.vuepress/assets/snack/44-1.png)

ë·°ëª¨ë¸ì—ì„œ ë°ì´í„°ë¥¼ ì§ì ‘ì ìœ¼ë¡œ ì†Œìœ í•˜ë‹¤ ë³´ë‹ˆ ë°ì´í„° íƒ€ì… ëª…ì„¸ì„œê°€ ë³€ê²½ë˜ì ë§ˆì ë¯¸ì¹œë“¯í•œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì˜€ë‹¤. ì´ê²ƒì´ ìœ ì§€ë³´ìˆ˜ê°€ ê³ ë ¤ë˜ì§€ ì•Šì€ ì•±ì´ë¼ëŠ” ê²ƒì„ ì ˆì‹¤íˆ ê¹¨ë‹«ëŠ” ì§€ì ì´ì—ˆë‹¤.

ë¬¸ì œë¥¼ ì§ì ‘ ê²½í—˜í•˜ë‹¤ ë³´ë‹ˆ ë ˆíŒŒì§€í† ë¦¬ íŒ¨í„´ì´ë¼ë˜ì§€, í´ë¦° ì•„í‚¤í…ì²˜ ê´€ì ì—ì„œ ë„ë©”ì¸ê³¼ í”„ë ˆì  í…Œì´ì…˜, ë°ì´í„° í˜•íƒœë¡œ ê³„ì¸µì„ êµ¬ë¶„í•˜ì—¬ ì•±ì„ ê°œë°œí•˜ëŠ” ì´ìœ ë¥¼ ì¡°ê¸ˆì´ë‚˜ë§ˆ í—¤ì•„ë ¤ë³¼ ìˆ˜ ìˆì—ˆë˜ ê²ƒ ê°™ë‹¤.

ì´ ê¸€ì—ì„œëŠ” ì¶œì‹œ ì¤€ë¹„ì¤‘ì¸ í¬ì¦ˆí”¼ì»¤ ì•±ì— í´ë¦° ì•„í‚¤í…ì²˜ë¥¼ ì ìš©í•´ê°€ëŠ” ê³¼ì •ì„ ì •ë¦¬í•˜ë ¤ê³  í•œë‹¤. ì´ ê¸€ ì‘ì„±ì— ë§ì€ ë„ì›€ì´ ëœ [ë©”ì´íŠ¸ëŸ¬ë„ˆ í´ë¦° ì•„í‚¤í…ì²˜ ë„ì…ê¸° ê¸€ì„](https://jeonyeohun.tistory.com/305) ê¼­ ì •ë…í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤!

## ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

í´ë¦° ì•„í‚¤í…ì²˜ê°€ ì ìš©ëœ ë‹¤ì´ì–´ê·¸ë¨ì„ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

![44-3](../.vuepress/assets/snack/44-3.png)

ì•± ë‚´ì— ë ˆì´ì–´ë“¤ì€ ì•„ë˜ì™€ ê°™ì´ êµ¬ë¶„ëœë‹¤.

1. ë„ë©”ì¸ ê³„ì¸µ: ëª¨ë¸, ìœ ìŠ¤ì¼€ì´ìŠ¤ í”„ë¡œí† ì½œ, ìœ ìŠ¤ì¼€ì´ìŠ¤ êµ¬í˜„ì²´
    - ëª¨ë¸: JSON ë””ì½”ë”©ì— ì‚¬ìš©ë  íƒ€ì…
    - ìœ ìŠ¤ì¼€ì´ìŠ¤ í”„ë¡œí† ì½œ: ì•± Sceneë³„ë¡œ ë¿Œë ¤ì¤„ ë°ì´í„° í˜•íƒœ
    - ìœ ìŠ¤ì¼€ì´ìŠ¤ êµ¬í˜„ì²´: í”„ë¡œí† ì½œ ì±„íƒ í›„ êµ¬í˜„ì´ ì´ë£¨ì–´ì§„ ì‹¤ì œ í´ë˜ìŠ¤
2. ë°ì´í„° ê³„ì¸µ: ë ˆíŒŒì§€í† ë¦¬ í”„ë¡œí† ì½œ, ë ˆíŒŒì§€í† ë¦¬ êµ¬í˜„ì²´
    - ë ˆíŒŒì§€í† ë¦¬ í”„ë¡œí† ì½œ: ë„¤íŠ¸ì›Œí¬ ìš”ì²­ íë¦„ì— ëŒ€í•œ ì •ì˜
    - ë ˆíŒŒì§€í† ë¦¬ êµ¬í˜„ì²´: í”„ë¡œí† ì½œ ì±„íƒ í›„ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì— ëŒ€í•œ ë‚´ë¶€ ì½”ë“œ. ìœ ìŠ¤ì¼€ì´ìŠ¤ì— ì£¼ì…í•  ë•ŒëŠ” íƒ€ì…ì„ í”„ë¡œí† ì½œë¡œ ì „ë‹¬í•˜ì—¬ ë‚´ë¶€ ì½”ë“œê°€ ì€ë‹‰í™”ëœë‹¤
3. í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µ: Sceneë³„ë¡œ ê·¸ë£¹í™” ì´í›„ ë·°ì™€ ë·°ëª¨ë¸, ì½”ë””ë„¤ì´í„°ë¡œ êµ¬ì„±
    - ì½”ë””ë„¤ì´í„°: í™”ë©´ ì´ë™ì˜ ë¡œì§ ì „ì²´ê°€ ì •ì˜ëœë‹¤. íë¦„ì„ í”„ë¡œí† ì½œë¡œ ë¨¼ì € ì •ì˜í•˜ê³  ì´ì— ëŒ€í•œ ì‹¤ì œ êµ¬í˜„ì„ í´ë˜ìŠ¤ì— ì •ì˜
    - ë·°ëª¨ë¸: ë·°ë¡œë¶€í„°ì˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë¡œì§ ì „ë°˜ì„ ì‘ì„±í•œë‹¤. ìœ ìŠ¤ì¼€ì´ìŠ¤ë¥¼ ë³´ìœ í•˜ë©° ì¸í’‹ì— ë”°ë¥¸ ìœ ìŠ¤ì¼€ì´ìŠ¤ ë°ì´í„° ë¡œë“œ íƒ€ì´ë°ì„ ì •ì˜í•˜ê²Œ ëœë‹¤.
    - ë·° ì»¨íŠ¸ë¡¤ëŸ¬: UI êµ¬í˜„
4. ì¸í”„ë¼ ê³„ì¸µ: ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ ì„¤ì • ë° ìš”ì²­ ì½”ë“œ ì‘ì„±, ë¼ìš°í„° ì •ì˜
    - ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤ í”„ë¡œí† ì½œ: ë„¤íŠ¸ì›Œí¬ ìš”ì²­ í˜•íƒœë¥¼ ì •ì˜í•œë‹¤. ì¼ë°˜ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì„ ìœ„í•œ Single ì˜µì €ë²„ë¸”ì„ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ì™€ ë©€í‹°íŒŒíŠ¸ POST í†µì‹ ì„ ìœ„í•œ `requestMultipartSingle` í•¨ìˆ˜ë¡œ êµ¬ì„±
    - ê°ì¢… ì—ëŸ¬, URLRequestì„ ë¦¬í„´í•´ì£¼ëŠ” ë¼ìš°í„° ì—´ê±°í˜•, ì¸ì¦ ë§Œë£Œ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ì¸í„°ì…‰í„°, ë””ë²„ê¹…ì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¡œê±° ì¡´ì¬
5. ê·¸ ì™¸: ìƒìˆ˜ê°’, ì—´ê±°í˜•, ì»´í¬ë„ŒíŠ¸ ë“±

## ì½”ë””ë„¤ì´í„° íŒ¨í„´

ì½”ë””ë„¤ì´í„°ëŠ” í”„ë ˆì  í…Œì´ì…˜ ë ˆì´ì–´ì— ì†í•œë‹¤. í™”ë©´ ì´ë™ ë¡œì§ë“¤ ì „ì²´ë¥¼ ë…ì ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê²Œ ëœë‹¤. `present` í˜¹ì€ `dismiss`ì™€ ê°™ì€ í•¨ìˆ˜ í˜¸ì¶œì€ ë·° ì»¨íŠ¸ë¡¤ëŸ¬ ë‚´ì—ì„œ ê°„ë‹¨í•˜ê²Œ ì´ë£¨ì–´ì§ˆ ìˆ˜ ìˆì§€ë§Œ, íŠ¹ì • UIì™€ì˜ ìƒí˜¸ì‘ìš©ì„ í†µí•´ ì´ë£¨ì–´ì§„ë‹¤ëŠ” ì ì—ì„œ ë·°ëª¨ë¸ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ë¥¼ ê´€ì°°í•˜ê³  ìˆì–´ì•¼ í•˜ë©° ì´ì— ë”°ë¥¸ ì²˜ë¦¬ ë¡œì§ ì—­ì‹œ ë·°ëª¨ë¸ ë‚´ì—ì„œ ì´ë£¨ì–´ì ¸ì•¼ í•œë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.

![44-4](../.vuepress/assets/snack/44-4.gif)

ìœ„ì˜ ì˜ˆì‹œ í™”ë©´ì„ ë³´ë©´ ì´ë¯¸ì§€ íƒ­ ì´í›„ í™•ëŒ€ëœ ì´ë¯¸ì§€ ë·°ë¥¼ ë³´ìœ í•œ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ presentí•˜ëŠ”ê²Œ ì „ë¶€ì¸ ë™ì‘ì´ì§€ë§Œ ë·° ì»¨íŠ¸ë¡¤ëŸ¬ ë‚´ì— ë¡œì§ì„ ë„£ì§€ ì•Šê³  ì½”ë””ë„¤ì´í„°ë¡œ ë¡œì§ì„ ì´ë™ì‹œí‚¨ë‹¤ëŠ” ê²ƒì´ë‹¤.

```swift
override func bindViewModel() {
    let input = PosePickViewModel.Input(
        selectedPeopleCount: selection.pressIndex.asObservable(),
        posepickButtonEvent: posePickerButton.rx.tap.asObservable(),
        isAnimating: isAnimating.asObservable(),
        imageViewTapEvent: imageViewTapEvent // ì´ë¯¸ì§€ íƒ­ ì´ë²¤íŠ¸ ì „ë‹¬
    )

    let output = viewModel?.transform(input: input, disposeBag: disposeBag)
    self.configureViewModelOutput(output)
}

@objc
func retrievedImageTapped() {
    guard let retrievedImage = retrievedImage.image else { return }
    imageViewTapEvent.onNext(retrievedImage)
}
```

ë·° ì»¨íŠ¸ë¡¤ëŸ¬ ë‚´ì— `private` ì„ ì–¸ëœ ì˜µì €ë²„ë¸”ì„ ì„ ì–¸í•´ë‘ê³  íƒ­ëœ ì´ë¯¸ì§€ë¥¼ ë·°ëª¨ë¸ì˜ ì¸í’‹ìœ¼ë¡œ ì „ë‹¬í•œë‹¤.

```swift
func transform(input: Input, disposeBag: DisposeBag) -> Output {
    let output = Output()

    /// ì´ë¯¸ì§€ë·° íƒ­ ì´í›„ ìƒì„¸ ì´ë¯¸ì§€ ë„ìš°ê¸°
    input.imageViewTapEvent
        .subscribe(onNext: { [weak self] in
            self?.coordinator?.presentDetailImage(retrievedImage: $0)
        })
        .disposed(by: disposeBag)

    return output
}
```

ë·°ëª¨ë¸ì—ì„œëŠ” ì½”ë””ë„¤ì´í„°ì— ë„ì›Œì¤„ ìƒì„¸ ì´ë¯¸ì§€ë¥¼ ì „ë‹¬í•œë‹¤. ì½”ë””ë„¤ì´í„° êµ¬í˜„ í´ë˜ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤

```swift
final class DefaultPosePickCoordinator: PosePickCoordinator {
    // ...

    func presentDetailImage(retrievedImage: UIImage?) {
        let vc = ImagePopUpViewController(mainImage: retrievedImage)
        vc.modalTransitionStyle = .crossDissolve
        vc.modalPresentationStyle = .overFullScreen
        self.navigationController.present(vc, animated: true)
    }
}
```

ëª¨ë“  ì½”ë””ë„¤ì´í„° í”„ë¡œí† ì½œì€ ë² ì´ìŠ¤ê°€ ë˜ëŠ” ê¸°ì´ˆ `Coordinator` í”„ë¡œí† ì½œì„ ìƒì†ë°›ëŠ”ë‹¤.

```swift
protocol Coordinator: AnyObject {
    var navigationController: UINavigationController { get set }
    var childCoordinators: [Coordinator] { get set }
    var type: CoordinatorType { get }
    func start()
    func finish()
    func findCoordinator(type: CoordinatorType) -> Coordinator?

    init(_ navigationController: UINavigationController)
}
```

í™”ë©´ ì „í™˜ íë¦„ì— ë”°ë¼ ë„¤ë¹„ê²Œì´ì…˜ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ìƒˆë¡œ ìƒì„±í•  ìˆ˜ë„, ì•„ë‹ˆë©´ í˜„ì¬ ë„¤ë¹„ê²Œì´ì…˜ ì»¨íŠ¸ë¡¤ëŸ¬ì— pushí• ì§€ presentí• ì§€ ë“±ì˜ ë¡œì§ë“¤ì€ ì§ì ‘ ì •ì˜í•˜ë©´ ëœë‹¤.

## ê°€ì¥ ê°„ë‹¨í•œ ê²ƒë¶€í„°

ì „ì²´ ì½”ë“œë¥¼ ë’¤ì—ê¸° ì „ ì–´ë””ë¶€í„° ì†ëŒ€ì•¼ í• ì§€ ê²°ì •í•´ì•¼ í–ˆë‹¤. í˜„ì¬ í¬ì¦ˆí”¼ì»¤ ì•±ì—ì„œëŠ” ë„¤ì»· í¬ì¦ˆë¥¼ ë‹¨ì–´ í˜•íƒœë¡œ ëœë¤í•˜ê²Œ ì œê³µí•´ì£¼ëŠ” ê¸°ëŠ¥ì´ ìˆëŠ”ë°, í•´ë‹¹ ì”¬ì˜ ê²½ìš° ë°ì´í„° ìš”ì²­ ë™ì‘ì´ GET í•˜ë‚˜ì¼ ë¿ ì•„ë‹ˆë¼ ë¶ˆëŸ¬ì˜¨ ì¸ìŠ¤í„´ìŠ¤ë¡œë¶€í„° `String`ê°’ë§Œ ì¶”ì¶œí•˜ì—¬ í™”ë©´ì— ë°”ì¸ë”©í•˜ë©´ ë˜ëŠ”ê²Œ ë‹¤ë¼ì„œ ì—¬ê¸°ë¶€í„° ë¦¬íŒ©í† ë§ì„ í•˜ê¸°ë¡œ ê²°ì •í–ˆë‹¤.

![44-2](../.vuepress/assets/snack/44-2.gif)

### ë¦¬íŒ©í† ë§ ì „

ê¸°ì¡´ ë·°ëª¨ë¸ í´ë˜ìŠ¤ë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

```swift
class PoseTalkViewModel: ViewModelType {
    var apiSession: APIService = APISession()
    var disposeBag = DisposeBag()

    struct Input {
        let poseTalkButtonTapped: ControlEvent<Void>
        let isAnimating: Observable<Bool>
    }

    struct Output {
        let animate: Driver<Void>
        let poseWord: Observable<String>
        let isLoading: BehaviorRelay<Bool>
    }

    func transform(input: Input) -> Output {
        let poseWord = BehaviorRelay<String>(value: "ì œì‹œì–´ì— ë§ì¶°\ní¬ì¦ˆë¥¼ ì·¨í•´ìš”!")
        let isLoading = BehaviorRelay<Bool>(value: false)

        input.poseTalkButtonTapped
            .flatMapLatest { [unowned self] _ -> Observable<PoseTalk> in
                self.apiSession.requestSingle(.retrievePoseTalk).asObservable()
            }
            .subscribe(onNext: {
                poseWord.accept($0.poseWord.content)
            })
            .disposed(by: disposeBag)

        /// ì• ë‹ˆë©”ì´ì…˜ + ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ ë¡œì§ ì¶”ê°€ë¥¼ ê³ ë ¤í•œ ì„¤ê³„
        input.isAnimating
            .subscribe(onNext: {
                isLoading.accept($0)
            })
            .disposed(by: disposeBag)

        return Output(animate: input.poseTalkButtonTapped.asDriver(), poseWord: poseWord.asObservable(), isLoading: isLoading)
    }
}
```

ë·°ëª¨ë¸ì´ ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤ ê°ì²´ë¥¼ ì§ì ‘ ì†Œìœ í•˜ê³  ìˆìœ¼ë©° ë²„íŠ¼ íƒ­ ì´í›„ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ë·°ëª¨ë¸ì—ì„œ ì§ì ‘ ì§„í–‰í•˜ê²Œ ëœë‹¤. ì´ ê³¼ì •ì—ì„œ `APISession` ê°ì²´ê°€ ì œë„¤ë¦­ìœ¼ë¡œ ì„ ì–¸ë˜ì–´ ìˆê¸°ì— íƒ€ì… ëª…ì‹œê°€ ì´ë£¨ì–´ì ¸ì•¼ í•˜ê³  ë°ì´í„° ì •ì œë„ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— `flatMapLatest`ì™€ ê°™ì€ ì˜¤í¼ë ˆì´í„°ê°€ í•„ì—°ì ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.

### ë¦¬íŒ©í† ë§ í›„

```swift
class PoseTalkViewModel {
    weak var coordinator: PoseTalkCoordinator?
    private let posetalkUseCase: PoseTalkUseCase

    init(coordinator: PoseTalkCoordinator?, posetalkUseCase: PoseTalkUseCase) {
        self.posetalkUseCase = posetalkUseCase
    }

    struct Input {
        let poseTalkButtonTapped: ControlEvent<Void>
        let isAnimating: BehaviorRelay<Bool>
    }

    struct Output {
        let animate = PublishSubject<Void>()
        let poseWord = PublishRelay<String>()
    }

    func transform(input: Input, disposeBag: DisposeBag) -> Output {
        self.configureInput(input, disposeBag: disposeBag)
        return createOutput(from: input, disposeBag: disposeBag)
    }

    private func configureInput(_ input: Input, disposeBag: DisposeBag) {
        input.poseTalkButtonTapped
            .subscribe(onNext: { [weak self] in
                self?.posetalkUseCase.fetchPoseTalk()
            })
            .disposed(by: disposeBag)
    }

    private func createOutput(from input: Input, disposeBag: DisposeBag) -> Output {
        let output = Output()

        input.poseTalkButtonTapped
            .subscribe(onNext: {
                output.animate.onNext(())
            })
            .disposed(by: disposeBag)

        Observable.combineLatest(self.posetalkUseCase.poseWord, input.isAnimating)
            .subscribe(onNext: { poseWord, animating in
                if !animating {
                    output.poseWord.accept(poseWord)
                }
            })
            .disposed(by: disposeBag)

        return output
    }
}
```

ì½”ë“œì˜ ê¸¸ì´ ìì²´ëŠ” ê¸¸ì–´ì¡Œì§€ë§Œ ê³„ì¸µì´ ë¶„ë¦¬ë˜ì–´ ë·°ëª¨ë¸ì˜ ë³¸ì§ˆì ì¸ ì±…ì„ì¸ **ë·°ë¡œë¶€í„°ì˜ ì´ë²¤íŠ¸ ìƒí˜¸ì‘ìš© ë¡œì§ì„ í‘œê¸°í•˜ëŠ” ê²ƒì—** ì§‘ì¤‘ë„ë¥¼ í™• ë†’ì¼ ìˆ˜ ìˆì—ˆë‹¤.

1. ë²„íŠ¼ì´ íƒ­ ëœ ì´í›„ ë·°ëª¨ë¸ì— ì£¼ì…ëœ ìœ ìŠ¤ì¼€ì´ìŠ¤ì— ë°ì´í„°ë¥¼ ìš”ì²­í•œë‹¤.
2. ë¹„ë™ê¸°ì ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ë¥¼ êµ¬ë…í•´ë‘” ë’¤ ë·°ì— ë¿Œë ¤ì¤„ ì•„ì›ƒí’‹ ì˜µì €ë²„ë¸”ì— ì „ë‹¬í•œë‹¤.

### ìœ ìŠ¤ì¼€ì´ìŠ¤

ìœ ìŠ¤ì¼€ì´ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í”„ë¡œí† ì½œê³¼ ì´ë¥¼ ì±„íƒí•˜ì—¬ êµ¬í˜„í•œ í´ë˜ìŠ¤ ë‘ê°œë¡œ êµ¬ë¶„ëœë‹¤. í¬ì¦ˆí†¡ ì”¬ì˜ ìœ ìŠ¤ì¼€ì´ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±ëœë‹¤.

```swift
protocol PoseTalkUseCase {
    var poseWord: PublishSubject<String> { get set }

    func fetchPoseTalk()
}
```

ì´ë¥¼ ì±„íƒí•˜ì—¬ êµ¬í˜„í•œ í´ë˜ìŠ¤ì˜ ê²½ìš° ì•„ë˜ì™€ ê°™ì´ ì‘ì„±ëœë‹¤.

```swift
final class DefaultPoseTalkUseCase: PoseTalkUseCase {
    private let posetalkRepository: DefaultPoseTalkRepository
    private var disposeBag = DisposeBag()

    var poseWord = PublishSubject<String>()

    init(posetalkRepository: DefaultPoseTalkRepository) {
        self.posetalkRepository = posetalkRepository
    }

    func fetchPoseTalk() {
        posetalkRepository.fetchPoseWord()
            .subscribe(onNext: { [weak self] poseTalk in
                self?.poseWord.onNext(poseTalk)
            })
            .disposed(by: disposeBag)
    }
}
```

ê° ìœ ìŠ¤ì¼€ì´ìŠ¤ í”„ë¡œí† ì½œì—ì„œëŠ” ì”¬ì—ì„œì˜ ë°ì´í„° ì¸í’‹ê³¼ ì•„ì›ƒí’‹ì„ ë³´ìœ í•˜ëŠ” ì±…ì„ì„ ê°–ë„ë¡ ì‘ì„±í–ˆë‹¤. í¬ì¦ˆí†¡ì˜ ê²½ìš° í™”ë©´ì— ë¿Œë ¤ì¤„ ë‹¨ì–´ê°€ ìœ ìŠ¤ì¼€ì´ìŠ¤ì˜ ì˜µì €ë²„ë¸” ì†ì„±ì— ë°”ì¸ë”©ë˜ì–´ ìˆê³ , ë°ì´í„°ë¥¼ ì§ì ‘ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ê°€ ì¡´ì¬í•œë‹¤.

ìœ ìŠ¤ì¼€ì´ìŠ¤ ì—­ì‹œ ë³¸ì§ˆì ì¸ ì±…ì„ì€ ë°ì´í„° ë³´ìœ  ë° ì „ë‹¬ì— ìˆê¸° ë•Œë¬¸ì—, ë°ì´í„°ë¥¼ ìš”ì²­í•˜ëŠ” ì±…ì„ì€ ë ˆíŒŒì§€í† ë¦¬ë¼ëŠ” ê°ì²´ì—ê²Œ ìœ„ì„ëœë‹¤.

### ë ˆíŒŒì§€í† ë¦¬

```swift
protocol PoseTalkRepository {
    func fetchPoseWord() -> Observable<String>
}
```

ë ˆíŒŒì§€í† ë¦¬ëŠ” ì–´ë–¤ ë°ì´í„°ë¥¼ ìš”ì²­í•  ì§€ì— ëŒ€í•œ í•¨ìˆ˜ë“¤ì„ êµ¬í˜„í•˜ê²Œ ëœë‹¤. í¬ì¦ˆí†¡ì˜ ê²½ìš° í¬ì¦ˆ í‚¤ì›Œë“œë¥¼ ì„œë²„ì—ê²Œ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ë§Œ êµ¬í˜„í•˜ë©´ ëœë‹¤.

```swift
final class DefaultPoseTalkRepository: PoseTalkRepository {
    let networkService: NetworkService

    init(networkService: NetworkService) {
        self.networkService = networkService
    }

    func fetchPoseWord() -> Observable<String> {
        let request: Observable<PoseTalk> = networkService.requestSingle(.retrievePoseTalk)
            .asObservable()
        return request.map { $0.poseWord.content }
    }
}
```

í¬ì¦ˆí†¡ ë ˆíŒŒì§€í† ë¦¬ êµ¬í˜„ì²´ì˜ ê²½ìš° ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤ ê°ì²´ë¥¼ ì†ì„±ìœ¼ë¡œ ê°€ì§€ë©° í•´ë‹¹ ê°ì²´ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì •ì œê¹Œì§€ í•œ ë’¤ ì˜µì €ë²„ë¸”ë¡œ ë¦¬í„´í•œë‹¤.

```swift
final class DefaultPoseTalkRepository: PoseTalkRepository {
    let networkService: NetworkService

    init(networkService: NetworkService) {
        self.networkService = networkService
    }

    func fetchPoseWord() -> Observable<String> {
        return networkService.requestSingle(.retrievePoseTalk)
            .asObservable()
            .map { (poseTalk: PoseTalk) -> String in
                return poseTalk.poseWord.content
            }
    }
}
```

ë ˆíŒŒì§€í† ë¦¬ì—ì„œ ë¦¬í„´í•œ ì˜µì €ë²„ë¸”ì„ ìœ ìŠ¤ì¼€ì´ìŠ¤ì—ì„œ êµ¬ë…í•˜ê³ , ìµœì¢…ì ìœ¼ë¡œ ë°ì´í„°ê°€ ë°©ì¶œë˜ë©´ ì´ë¥¼ ë·°ê¹Œì§€ ë¿Œë ¤ì£¼ëŠ” í”Œë¡œìš°ë¥¼ ê°–ëŠ” ê²ƒì´ë‹¤.

ë·°ëª¨ë¸ì—ì„œ ë°ì´í„° ìš”ì²­ ë° ì •ì œ ë“± ëª¨ë“  ì‘ì—…ë“¤ì„ ì¼ì„í•˜ë‹¤ê°€ ì±…ì„ë“¤ì„ ìœ ìŠ¤ì¼€ì´ìŠ¤ì™€ ë ˆíŒŒì§€í† ë¦¬ì— ë¶„ì‚°ì‹œì¼œ ê´€ë¦¬í•˜ë‹ˆ ë·°ëª¨ë¸ì˜ ì§ê´€ì„±ì´ í–¥ìƒë˜ì—ˆìœ¼ë©° í¬ì¦ˆí”¼ë“œ ì”¬ì˜ ê²½ìš° ì½”ë“œëŸ‰ ìì²´ê°€ ëˆˆì—ë„ê²Œ ì¤„ì–´ë“¤ê²Œ ë˜ì—ˆë‹¤.

## í…ŒìŠ¤íŠ¸ì½”ë“œ ì‘ì„± - 1. ìœ ìŠ¤ì¼€ì´ìŠ¤

í¬ì¦ˆí”¼ì»¤ ì•±ì€ ì£¼ëœ ì»¨í…ì¸ ê°€ ì´ë¯¸ì§€ì´ê¸° ë•Œë¬¸ì— ìºì‹œ ê¸°ë°˜ìœ¼ë¡œ ì•±ì´ ë™ì‘í•˜ê²Œ ëœë‹¤. í‚¹í”¼ì…”ì˜ ê²½ìš° ë©”ëª¨ë¦¬ í˜¹ì€ ë””ìŠ¤í¬ì— ì ‘ê·¼í•œ ë’¤ URLê°’ì„ í‚¤ë¡œ ì ‘ê·¼í–ˆì„ ë•Œ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ëŠ” ê²½ìš° ìë™ì ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ë¥¼ í†µí•´ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œ í•˜ê²Œ ëœë‹¤.

ì´ë•Œ ëª©ì—… URL í”„ë¡œí† ì½œì„ ì£¼ì…í•´ë†“ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ìƒí™©ì—ì„œ xcode í”„ë¡œì íŠ¸ì˜ ë¡œì»¬ì— ì €ì¥ë˜ì–´ ìˆëŠ” ì´ë¯¸ì§€ë¥¼ ë„¤íŠ¸ì›Œí¬ë¡œë¶€í„° ë¶ˆëŸ¬ì˜¨ ì´ë¯¸ì§€ ëŒ€ì²´ìš©ìœ¼ë¡œ ì „ë‹¬í•œ ë’¤ ì„¸ì…˜ ê°ì²´ë¥¼ ì¢…ë£Œí•  ìˆ˜ ìˆê²Œ ëœë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [ë‹¤ìŒ ë§í¬ë¥¼](https://parkjju.github.io/vue-TIL/trash/231205-39.html) ì°¸ì¡°í•˜ë©´ ì¢‹ë‹¤.

ë”°ë¼ì„œ ìœ ìŠ¤ì¼€ì´ìŠ¤ í•¨ìˆ˜ í˜¸ì¶œ ì´í›„ì—, ì´ë¯¸ì§€ ìºì‹±ì´ ì •ìƒì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ëŠ” ì§€ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ê²Œ ëœ ê²ƒì´ë‹¤. ìœ ìŠ¤ì¼€ì´ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë ˆíŒŒì§€í† ë¦¬ë¥¼ ì£¼ì…ë°›ëŠ”ë°, ì˜ì¡´ì„± ì£¼ì… í˜•íƒœë¡œ ì½”ë“œë¥¼ ë¦¬íŒ©í† ë§ í•˜ì˜€ê¸°ì— ì‹¤ì œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ì§„í–‰í•˜ëŠ” ë ˆíŒŒì§€í† ë¦¬ ê°ì²´ë¥¼ ì£¼ì…í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, ë°ì´í„°ë¥¼ ì •ìƒì ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¨ ì´í›„ ìƒí™©ìœ¼ë¡œ í•˜ë“œì½”ë”©ëœ ê°€ì§œ ë°ì´í„° ì˜µì €ë²„ë¸”ì„ ë¦¬í„´í•˜ê²Œ ëœë‹¤.

```swift
final class PosePickUseCaseTests: XCTestCase {

    private var disposeBag = DisposeBag()
    private var posepickRespository: PosePickRepository!
    private var posepickUseCase: PosePickUseCase!
    private var scheduler: TestScheduler!

    override func setUp() {
        super.setUp()

        // í‚¹í”¼ì…” ImageDownloader ê°ì²´ì— ëª©ì—… í”„ë¡œí† ì½œ ì£¼ì…
        let imageDownloader: ImageDownloader = {
            let downloader = ImageDownloader.default
            let configuration = URLSessionConfiguration.default
            configuration.protocolClasses = [MockURLProtocol.self]
            downloader.sessionConfiguration = configuration
            return downloader
        }()

        // í¬ì¦ˆí”½ ë ˆíŒŒì§€í† ë¦¬ ì£¼ì…
        self.posepickRespository = MockPosePickRepository(imageDownloader: imageDownloader)

        // ìœ ìŠ¤ì¼€ì´ìŠ¤ ìƒì„±ê³¼ í•¨ê»˜ ëª©ì—… ë ˆíŒŒì§€í† ë¦¬ ì£¼ì…
        self.posepickUseCase = DefaultPosePickUseCase(
            posepickRepository: self.posepickRespository
        )

        self.scheduler = .init(initialClock: 0)

        ImageCache.default.clearCache()
    }

    func test_ë””ìŠ¤í¬_ìºì‹±_ì²˜ë¦¬ê°€_ì˜_ë˜ëŠ”ì§€ (){
        let expectation = XCTestExpectation(description: "í¬ì¦ˆí”½ ìœ ìŠ¤ì¼€ì´ìŠ¤ ë°ì´í„° ì˜ ë¶ˆëŸ¬ì˜¤ëŠ”ì§€")

        MockURLProtocol.responseWithStatusCode(code: 200)
        MockURLProtocol.responseWithDTO(type: .cacheImage)

        self.scheduler.createColdObservable([
            .next(0, ())
        ])
        .subscribe(onNext: { [weak self] in
            self?.posepickUseCase
                .fetchPosePick(peopleCount: 4)
        })
        .disposed(by: disposeBag)

        self.posepickUseCase
            .poseImage
            .subscribe(onNext: {
                print($0)
                expectation.fulfill()
            })
            .disposed(by: self.disposeBag)

        self.scheduler.start()

        wait(for: [expectation], timeout: 5)
    }

    override func tearDown() {
        super.tearDown()
        self.disposeBag = DisposeBag()
        self.posepickUseCase = nil
        self.posepickRespository = nil
        self.scheduler = nil

        ImageDownloader.default.sessionConfiguration = .default
    }
}
```

ë ˆíŒŒì§€í† ë¦¬ì˜ ê²½ìš° í”„ë¡œí† ì½œ ê¸°ë°˜ìœ¼ë¡œ ì„ ì–¸ëœ í•¨ìˆ˜ ë¦¬ìŠ¤íŠ¸ë§Œ í•„ìˆ˜ì ìœ¼ë¡œ êµ¬í˜„í•˜ë©´ í™•ì¥ì„± ìˆê²Œ ê°ì²´ ìƒì„±ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œë„ ë ˆíŒŒì§€í† ë¦¬ íƒ€ì…ì„ í”„ë¡œí† ì½œë¡œ ì„ ì–¸í•œ ë’¤, ì‹¤ì œ ê°ì²´ ìƒì„± ë‹¨ê³„ì—ì„œëŠ” ëª©ì—… ê°ì²´ë¥¼ ì£¼ì…í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤.

ëª©ì—… ë ˆíŒŒì§€í† ë¦¬ ì½”ë“œë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

```swift
final class MockPosePickRepository: PosePickRepository {
    func fetchPoseImage(peopleCount: Int) -> Observable<UIImage?> {
        return Observable.just("TEST URL.com")
            .withUnretained(self)
            .flatMapLatest { (owner, imageURL) -> Observable<UIImage?> in
                return owner.cacheItem(for: imageURL)
            }
    }

    let imageDownloader: ImageDownloader

    init(imageDownloader: ImageDownloader = ImageDownloader.default) {
        self.imageDownloader = imageDownloader
    }

    private func cacheItem(for imageURL: String) -> Observable<UIImage?> {
        return Observable.create { observer in
            ImageCache.default.retrieveImageInDiskCache(forKey: imageURL) { [weak self] result in
                guard let self = self else { return }
                switch result {
                case .success(let value):
                    if let image = value?.images?.first {
                        observer.onNext(image)
                    } else if let url = URL(string: imageURL) {
                        KingfisherManager.shared.retrieveImage(with: url, options: [.downloader(self.imageDownloader)]) { downloadResult in
                            switch downloadResult {
                            case .success(let downloaded):
                                observer.onNext(downloaded.image)
                            case .failure(let error):
                                observer.onError(error)
                            }
                        }
                    }
                case .failure(let error):
                    observer.onError(error)
                }
            }
            return Disposables.create {

            }
        }
    }
}
```

ì´ë¯¸ì§€ ìš”ì²­ì´ ë“¤ì–´ì˜¤ê²Œ ë˜ë©´ ì‹¤ì œ ë ˆíŒŒì§€í† ë¦¬ì—ì„œëŠ” í¬ì¦ˆ ë‚´ì˜ `imageKey`ë¼ëŠ” ì—”í‹°í‹° ì†ì„±ìœ¼ë¡œë¶€í„° URLì„ ì¶”ì¶œí•˜ì—¬ í‚¹í”¼ì…” `retrieveImage` í•¨ìˆ˜ì— ì „ë‹¬í•˜ê²Œ ëœë‹¤.

í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œëŠ” ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ í•„ìš” ì—†ê¸° ë•Œë¬¸ì— í‚¹í”¼ì…”ì— í•˜ë“œì½”ë”©ëœ ê°€ì§œ URLì„ ì „ë‹¬í•œë‹¤. í‚¹í”¼ì…” ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë” ê°ì²´ì— ì£¼ì…í•œ ëª©ì—… í”„ë¡œí† ì½œë¡œ ì¸í•´ ë¡œì»¬ì— ì €ì¥ëœ ì´ë¯¸ì§€ì˜ ì‚¬ì´ì¦ˆë¥¼ ê³„ì‚°í•˜ì—¬ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì˜µì €ë²„ë¸”ì— ì´ë²¤íŠ¸ë¡œ ë°©ì¶œí•˜ê²Œ ëœë‹¤.

## í…ŒìŠ¤íŠ¸ì½”ë“œ ì‘ì„± - 2. ë·°ëª¨ë¸

ë·°ëª¨ë¸ì˜ ê²½ìš°

## ì½”ë””ë„¤ì´í„° íŒ¨í„´

## Reference

1. [Template iOS App using Clean Architecture and MVVM](https://github.com/kudoleh/iOS-Clean-Architecture-MVVM)
2. [ë©”ì´íŠ¸ëŸ¬ë„ˆ: MVVM + Clean Architecture + RxSwift ë„ì…ê¸°](https://jeonyeohun.tistory.com/305)
