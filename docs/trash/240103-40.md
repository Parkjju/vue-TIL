---
title: Snack 40호 - [RxSwift] unowned self를 써도 안전할까?
---

## 들어가며

`RxSwift`로 프로젝트를 진행하다보니 클로저를 정말 수도 없이 사용하게 되었다. `weak self`로 코드를 작성하다보니 바인딩 로직이 너무 복잡해져서, `unowned self` 기반으로 코드를 작성해도 되는지 찾아보다가 스택오버플로우에서 `disposeBag` 기반으로 동작하는 옵저버블은 괜찮다고 하는 글이 있어서 `unowned self` 기반으로 코드를 작성했었다.

왜 이러한 코드가 안전한지, 안전한건 실제로 맞는 지에 대한 면밀한 검증없이 코드를 작성한 것이 자꾸 마음에 걸려 이번 기회에 정리해보려고 한다.

## Capturing

클로저는 참조 타입이어서 함수 묶음의 주소가 힙 영역에 남는다. 이때 클로저 내에서 외부 값을 사용하게 될때 **외부 값의 주소를** 클로저 내에서 참조하게 된다.

```swift
var stored = 0

let closure = { (number: Int) -> Int in
    stored += number
    return stored
}

print(closure(3)) // 3
print(stored) // 3
```

위 예시코드에서 `closure`라는 이름의 클로저는 외부 값인 `stored` 변수의 참조를 갖는다. 이에 따라 `closure(3)`이 `stored` 변수 값을 직접 변경하는 동작이 이루어진 것이다.

```swift
func calculateFunc() -> ((Int) -> Int) {
    var sum = 0

    func square(num: Int) -> Int {
        sum += (num * num)
        return sum
    }

    return square
}

let returnedFunc = calculateFunc()

returnedFunc(3) // square 호출 후 캡처중인 sum에 9 더하기
returnedFunc(4) // square 호출 후 캡처중인 sum에 16 더하기
// 최종 sum값은 25가 됨
```

1. `calculateFunc` 호출로 스택 프레임에 함수가 하나 쌓임
2. `sum` 변수를 캡처링하는 `square` 함수를 리턴하며 스택 프레임 해제
3. 리턴된 `square` 함수 묶음은 힙에 저장

`square` 함수가 클로저로 힙에 저장되면서 동시에 `sum`변수를 캡처링하여 힙에서 참조를 하게 된다. 이에 따라 클로저 호출로 `sum` 변수에 콜 바이 레퍼런스 동작이 이루어진다.

:::tip @escaping 키워드

함수 파라미터에 전달되는 클로저를 외부 변수에 저장하려면 파라미터 앞에 `@escaping`키워드를 붙여야 한다.

```swift
var handler: () -> () = { print("HANDLER") } // 클로저 저장

func performEscaping(completion: @escaping () -> ()) {
    print("HI")
    handler = completion // 파라미터의 completion 클로저를 외부 변수에 할당
    // 캡처링이 이루어짐
}

handler() // HANDLER

performEscaping { // perfomEscaping 실행과 함께 HI 출력
    print("YEAH") // print("YEAH") 클로저가 handler에 할당
}

handler() // YEAH
```

:::

## 캡처 리스트

## Reference

1. [stackoverflow - RxSwift: Is it safe to always use [unowned self] when a class has a disposeBag property?](https://stackoverflow.com/questions/46844148/rxswift-is-it-safe-to-always-use-unowned-self-when-a-class-has-a-disposebag-p)
2. [Hacking with swift - Capturing values](https://www.hackingwithswift.com/sixty/6/11/capturing-values)
3. [Hacking with swift - Capture lists in Swift: what’s the difference between weak, strong, and unowned references?](https://www.hackingwithswift.com/articles/179/capture-lists-in-swift-whats-the-difference-between-weak-strong-and-unowned-references)
